import{a as rt}from"./chunk-FOF6UJEQ.js";import{a as it,b as at}from"./chunk-5WQUE5VX.js";import{a as Z}from"./chunk-GMW7M4BS.js";import{a as et}from"./chunk-AAMRNNEM.js";import{a as A}from"./chunk-TTATSR4U.js";import{e as q}from"./chunk-PRIUQE34.js";import{a as tt}from"./chunk-G3OXHIUX.js";import{c as W,e as B,f as L,h as G,j as J,k as K,s as Q,u as X,v as Y}from"./chunk-OLGVRGRS.js";import{Bb as E,Db as h,Fa as U,Fb as g,G as _,Ka as l,Pa as d,Qb as m,Rb as $,Sb as D,Tc as P,V as w,Vb as M,Wa as T,Wb as F,Wc as H,Xb as I,Y as j,a as p,aa as y,b as f,d as k,ha as u,ia as b,lb as V,mb as O,pb as R,q as x,qa as C,qb as N,rb as v,sb as n,tb as o,ub as z}from"./chunk-JLM7LPRF.js";var S=class s{constructor(i,t){this.http=i;this.habitatService=t}apiUrl=`${H.apiUrl}/api/admin/habitats`;getAllHabitats(){return this.http.get(this.apiUrl).pipe(w(()=>{}),_(i=>this.handleError("chargement des habitats",i)))}createHabitat(i){return this.http.post(this.apiUrl,i).pipe(w(t=>{console.log("R\xE9ponse du serveur (cr\xE9ation):",t),this.habitatService.clearCache()}),_(t=>(console.error("Erreur d\xE9taill\xE9e (cr\xE9ation):",t),this.handleError("cr\xE9ation de l'habitat",t))))}updateHabitat(i,t,e){if(!i)return x(()=>new Error("ID invalide"));let r=new FormData;return Object.entries(t).forEach(([a,c])=>{c!=null&&a!=="images"&&r.append(a,typeof c=="object"?JSON.stringify(c):String(c))}),e&&r.append("images",e),this.http.put(`${this.apiUrl}/${i}`,r).pipe(w(a=>{console.log("R\xE9ponse du serveur (mise \xE0 jour):",a),this.habitatService.clearCache()}),_(a=>(console.error("Erreur d\xE9taill\xE9e (mise \xE0 jour):",a),this.handleError("mise \xE0 jour de l'habitat",a))))}deleteHabitat(i){return this.http.delete(`${this.apiUrl}/${i}`).pipe(w(()=>{console.log("Habitat supprim\xE9 avec succ\xE8s:",i),this.habitatService.clearCache()}),_(t=>(console.error("Erreur lors de la suppression:",t),this.handleError("suppression de l'habitat",t))))}handleError(i,t){return console.error(`Erreur lors de ${i}:`,t),x(()=>new Error(`Erreur lors de ${i}`))}static \u0275fac=function(t){return new(t||s)(y(P),y(Z))};static \u0275prov=j({token:s,factory:s.\u0275fac,providedIn:"root"})};var lt=(s,i)=>i.id_habitat;function ct(s,i){if(s&1){let t=E();n(0,"div",6)(1,"div",19),z(2,"img",20),n(3,"div",21)(4,"h3",22),m(5),o()()(),n(6,"div",23)(7,"p",24),m(8),o(),n(9,"div",25)(10,"app-button",26),h("click",function(){let r=u(t).$implicit,a=g();return b(a.editHabitat(r.id_habitat))})("keydown",function(){let r=u(t).$implicit,a=g();return b(a.editHabitat(r.id_habitat))}),o(),n(11,"app-button",26),h("click",function(){let r=u(t).$implicit,a=g();return b(a.deleteHabitat(r.id_habitat))})("keydown",function(){let r=u(t).$implicit,a=g();return b(a.deleteHabitat(r.id_habitat))}),o()()()()}if(s&2){let t=i.$implicit;l(2),v("src",t.images,U)("alt",t.name),l(3),$(t.name),l(3),D(" ",t.description," "),l(2),v("text","Modifier")("color","tertiary")("rounded",!0)("customClass","px-6 min-w-[120px] text-lg font-medium"),l(),v("text","Supprimer")("color","danger")("rounded",!0)("customClass","px-6 min-w-[120px] text-lg font-medium")}}function mt(s,i){if(s&1){let t=E();n(0,"app-button",27),h("click",function(){u(t);let r=g();return b(r.cancelEdit())})("keydown",function(){u(t);let r=g();return b(r.cancelEdit())}),o()}s&2&&v("text","Annuler")("color","secondary")("rounded",!0)("customClass","px-6 min-w-[120px] text-lg font-medium")}var nt=class s{constructor(i,t,e,r,a,c,dt){this.router=i;this.habitatManagement=t;this.countResourceService=e;this.toastService=r;this.fileSecurityService=a;this.imageOptimizer=c;this.imageUrlService=dt}habitats=C([]);selectedFile=C(null);newHabitatData={};imageBaseUrl=`${H.apiUrl}/api`;ngOnInit(){this.loadHabitats()}loadHabitats(){this.habitatManagement.getAllHabitats().subscribe({next:i=>{this.habitats.set(i.map(t=>f(p({},t),{showDescription:!1,showDeleteConfirmation:!1,images:this.formatImageUrl(t.images)})))},error:i=>{console.error("Erreur lors de la r\xE9cup\xE9ration des habitats:",i),this.toastService.showError("Erreur lors du chargement des habitats")}})}onFileSelected(i){return k(this,null,function*(){let t=i.target.files?.[0];if(t)try{let e=yield this.fileSecurityService.scan(t);if(!e.isSafe){this.toastService.showError(e.threats.join(`
`));return}this.selectedFile.set(t);let r=new FileReader;r.onload=()=>{this.newHabitatData.images=r.result},r.readAsDataURL(t),this.toastService.showSuccess("Image s\xE9lectionn\xE9e avec succ\xE8s")}catch(e){console.error("Erreur lors du traitement du fichier:",e),this.toastService.showError("Erreur lors du traitement du fichier")}})}createHabitat(){if(this.validateHabitatData()){let i=this.buildFormData();this.habitatManagement.createHabitat(i).subscribe({next:()=>{this.resetForm(),this.loadHabitats(),this.countResourceService.incrementTotalHabitats(),this.toastService.showSuccess("Habitat cr\xE9\xE9 avec succ\xE8s")},error:t=>{console.error("Erreur lors de la cr\xE9ation de l'habitat :",t),this.toastService.showError("Erreur lors de la cr\xE9ation de l'habitat")}})}else this.toastService.showError("Veuillez remplir tous les champs requis")}updateHabitat(){if(this.validateHabitatData(!0)){let i=this.newHabitatData.id_habitat.toString(),t={name:this.newHabitatData.name,description:this.newHabitatData.description,id_habitat:this.newHabitatData.id_habitat};this.habitatManagement.updateHabitat(i,t,this.selectedFile()).subscribe({next:e=>{let r=this.formatImageUrl(e.images);this.habitats.update(a=>a.map(c=>c.id_habitat===e.id_habitat?f(p({},e),{showDescription:c.showDescription,images:r}):c)),this.resetForm(),this.toastService.showSuccess("Habitat mis \xE0 jour avec succ\xE8s")},error:e=>{console.error("Erreur lors de la mise \xE0 jour de l'habitat:",e),this.toastService.showError("Erreur lors de la mise \xE0 jour de l'habitat")}})}else this.toastService.showError("Veuillez remplir tous les champs requis")}formatImageUrl(i){return this.imageUrlService.getImageUrl(i)}getImageUrl(i){return this.imageUrlService.getImageUrl(i)}editHabitat(i){let t=this.habitats().find(e=>e.id_habitat===i);t&&(this.newHabitatData=p({},t),this.toastService.showSuccess("Habitat s\xE9lectionn\xE9 pour modification"))}confirmDeleteHabitat(i){this.habitats.update(t=>t.map(e=>e.id_habitat===i?f(p({},e),{showDeleteConfirmation:!0}):e))}cancelDeleteHabitat(i){this.habitats.update(t=>t.map(e=>e.id_habitat===i?f(p({},e),{showDeleteConfirmation:!1}):e))}deleteHabitat(i){if(!i){this.toastService.showError("ID d'habitat invalide");return}this.habitatManagement.deleteHabitat(i.toString()).subscribe({next:()=>{this.habitats.update(t=>t.filter(e=>e.id_habitat!==i)),this.countResourceService.decrementTotalHabitats(),this.loadHabitats(),this.resetForm(),this.toastService.showSuccess("Habitat supprim\xE9 avec succ\xE8s")},error:t=>{console.error("Erreur lors de la suppression de l'habitat:",t),this.toastService.showError("Erreur lors de la suppression de l'habitat")}})}resetForm(){this.newHabitatData={},this.selectedFile.set(null)}cancelEdit(){this.resetForm(),this.toastService.showSuccess("Modification annul\xE9e")}toggleDescription(i){this.habitats.update(t=>t.map(e=>e.id_habitat===i?f(p({},e),{showDescription:!e.showDescription}):e))}goBack(){this.router.navigate(["/admin"])}validateHabitatData(i=!1){let{name:t,description:e}=this.newHabitatData,r=i||this.newHabitatData.images||this.selectedFile();return!!(t&&e&&r)}buildFormData(){let i=new FormData,t=this.newHabitatData;Object.entries(t).forEach(([r,a])=>{a!=null&&i.append(r,a.toString())});let e=this.selectedFile();if(e){let r=this.imageOptimizer.sanitizeFileName(e.name);i.append("images",e,r)}return i}static \u0275fac=function(t){return new(t||s)(d(q),d(S),d(et),d(A),d(it),d(rt),d(at))};static \u0275cmp=T({type:s,selectors:[["app-habitat-management"]],decls:29,vars:8,consts:[[1,"w-full","bg-gradient-to-b","from-secondary","to-primary","shadow-lg","py-8"],[1,"container","mx-auto","px-4"],[1,"text-center","space-y-4","mb-12"],[1,"text-3xl","md:text-5xl","lg:text-6xl","font-serif","font-bold","text-quinary"],[1,"text-lg","md:text-xl","text-tertiary","font-serif","italic","max-w-4xl","mx-auto"],[1,"grid","grid-cols-1","md:grid-cols-2","lg:grid-cols-3","gap-6","mb-12"],[1,"bg-white/80","backdrop-blur-sm","rounded-xl","shadow-lg","overflow-hidden"],[1,"bg-white/80","backdrop-blur-sm","rounded-xl","shadow-lg","p-6"],[1,"text-2xl","font-serif","font-semibold","text-tertiary","mb-6"],["enctype","multipart/form-data",1,"space-y-6",3,"ngSubmit"],["for","name",1,"block","text-lg","font-medium","text-tertiary","mb-2"],["type","text","id","name","name","name","required","","placeholder","Nom de l'habitat",1,"w-full","p-3","border","border-secondary/30","rounded-lg","focus:ring-2","focus:ring-tertiary","focus:border-transparent",3,"ngModelChange","ngModel"],["for","description",1,"block","text-lg","font-medium","text-tertiary","mb-2"],["id","description","name","description","required","","rows","4","placeholder","Description de l'habitat",1,"w-full","p-3","border","border-secondary/30","rounded-lg","focus:ring-2","focus:ring-tertiary","focus:border-transparent",3,"ngModelChange","ngModel"],["for","image",1,"block","text-lg","font-medium","text-tertiary","mb-2"],["type","file","id","image","accept","image/*",1,"w-full","p-3","border","border-secondary/30","rounded-lg","focus:ring-2","focus:ring-tertiary","focus:border-transparent",3,"change"],[1,"flex","justify-end","space-x-4"],["type","button",3,"text","color","rounded","customClass"],["type","submit",3,"keydown","text","color","rounded","customClass"],[1,"relative","h-48"],[1,"w-full","h-full","object-cover",3,"src","alt"],[1,"absolute","bottom-0","left-0","right-0","bg-black/50","p-4"],[1,"text-white","font-serif","text-xl"],[1,"p-4"],[1,"text-gray-600","mb-4","line-clamp-3"],[1,"flex","justify-end","space-x-2"],[3,"click","keydown","text","color","rounded","customClass"],["type","button",3,"click","keydown","text","color","rounded","customClass"]],template:function(t,e){t&1&&(n(0,"section",0)(1,"div",1)(2,"div",2)(3,"h1",3),m(4," Gestion des Habitats "),o(),n(5,"p",4),m(6," G\xE9rez les habitats du zoo "),o()(),n(7,"div",5),R(8,ct,12,12,"div",6,lt),o(),n(10,"div",7)(11,"h3",8),m(12),o(),n(13,"form",9),h("ngSubmit",function(){return e.newHabitatData.id_habitat?e.updateHabitat():e.createHabitat()}),n(14,"div")(15,"label",10),m(16," Nom de l'habitat "),o(),n(17,"input",11),I("ngModelChange",function(a){return F(e.newHabitatData.name,a)||(e.newHabitatData.name=a),a}),o()(),n(18,"div")(19,"label",12),m(20," Description "),o(),n(21,"textarea",13),I("ngModelChange",function(a){return F(e.newHabitatData.description,a)||(e.newHabitatData.description=a),a}),o()(),n(22,"div")(23,"label",14),m(24," Image "),o(),n(25,"input",15),h("change",function(a){return e.onFileSelected(a)}),o()(),n(26,"div",16),V(27,mt,1,4,"app-button",17),n(28,"app-button",18),h("keydown",function(a){return a.key==="Enter"&&(e.newHabitatData.id_habitat?e.updateHabitat():e.createHabitat())}),o()()()()()()),t&2&&(l(8),N(e.habitats()),l(4),D(" ",e.newHabitatData.id_habitat?"Modifier l'habitat":"Ajouter un habitat"," "),l(5),M("ngModel",e.newHabitatData.name),l(4),M("ngModel",e.newHabitatData.description),l(6),O(e.newHabitatData.id_habitat?27:-1),l(),v("text",e.newHabitatData.id_habitat?"Mettre \xE0 jour":"Cr\xE9er")("color","tertiary")("rounded",!0)("customClass","px-6 min-w-[120px] text-lg font-medium"))},dependencies:[Y,K,W,B,L,Q,X,J,G,tt],encapsulation:2})};export{nt as HabitatManagementComponent};
