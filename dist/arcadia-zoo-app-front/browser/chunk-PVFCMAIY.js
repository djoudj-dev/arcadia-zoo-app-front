import{a as k}from"./chunk-YQ5HTG6F.js";import{a as f}from"./chunk-IQHRYKAE.js";import{d as v}from"./chunk-P5Z6PEHU.js";import{A as h,E as a,Qa as u,T as l,Tb as s,W as c,aa as o,nc as p,o as i,qc as d}from"./chunk-TKCV3HAR.js";var m=class n{apiUrl=`${d.apiUrl}`;http=o(p);router=o(v);toastService=o(k);tokenService=o(f);authState=u({user:null,isAuthenticated:!1,role:null});user=s(()=>this.authState().user);isAuthenticated=s(()=>this.authState().isAuthenticated);userRole=s(()=>this.authState().role);constructor(){this.initializeCurrentUser(),this.isAuthenticated()&&h(6e4).subscribe(()=>this.checkTokenExpiration())}initializeCurrentUser(){let e=localStorage.getItem("user"),t=this.tokenService.getToken();if(e&&t)try{let r=JSON.parse(e);this.authState.set({user:r,isAuthenticated:!0,role:r.role?.name??null})}catch{this.handleInvalidUserData()}}login(e,t){return this.http.post(`${this.apiUrl}/api/auth/login`,{email:e,password:t}).pipe(l(r=>{this.handleSuccessfulLogin(r.user)}),a(r=>this.handleLoginError(r)))}refreshToken(){let e=this.tokenService.getRefreshToken();return e?this.http.post(`${this.apiUrl}/auth/token/refresh`,{refreshToken:e}).pipe(l(t=>{this.tokenService.setTokens(t.accessToken,t.refreshToken)}),a(t=>(console.error("Erreur de rafra\xEEchissement du token:",t),this.logout(),i(()=>t)))):(this.logout(),i(()=>new Error("Refresh token non trouv\xE9")))}logout(){this.authState.set({user:null,isAuthenticated:!1,role:null}),localStorage.removeItem("user"),this.tokenService.removeTokens(),this.toastService.showSuccess("D\xE9connexion r\xE9ussie !",2500),setTimeout(()=>this.router.navigate(["/login"]),2500)}checkTokenExpiration(){let e=this.tokenService.getToken();e&&this.tokenService.isTokenExpiringSoon(e)&&this.refreshToken().subscribe()}handleSuccessfulLogin(e){if(e.role&&e.token)this.tokenService.setTokens(e.token,e.refreshToken??""),this.authState.set({user:e,isAuthenticated:!0,role:e.role?.name}),localStorage.setItem("user",JSON.stringify(e)),this.toastService.showSuccess("Connexion r\xE9ussie. Bienvenue!");else throw new Error("Donn\xE9es utilisateur invalides")}handleLoginError(e){let t=e.error?.message||"Erreur de connexion. V\xE9rifiez vos identifiants.";return this.toastService.showError(t),i(()=>e)}handleInvalidUserData(){this.logout()}static \u0275fac=function(t){return new(t||n)};static \u0275prov=c({token:n,factory:n.\u0275fac,providedIn:"root"})};export{m as a};
