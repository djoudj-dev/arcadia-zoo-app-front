import{a as $}from"./chunk-QMO5IVA6.js";import{a as A}from"./chunk-IMR7M5YK.js";import{a as T}from"./chunk-2YBA2I4T.js";import{H as p,Kc as S,Lc as V,Nc as h,Qc as o,V as u,X as c,_ as m,_a as b,a as d,b as v,da as f,ea as n,k as y,p as l,u as s}from"./chunk-RMHEMJYH.js";var g=class r{constructor(t){this.http=t}apiUrl=`${o.apiUrl}/api/animals`;habitatUrl=`${o.apiUrl}/api/habitats`;imageBaseUrl=`${o.apiUrl}/api/uploads/animals`;animalsSignal=b([]);cacheLoadedSignal=b(!1);formatImageUrl(t){if(!t)return"";if(t.startsWith("http"))return t;let e=t.replace(/^uploads\/animals\//,"");return`${this.imageBaseUrl}/${e}`}getAnimals(){return this.http.get(this.apiUrl).pipe(s(t=>t.map(e=>v(d({},e),{images:this.formatImageUrl(e.images)}))),c(t=>{this.animalsSignal.set(t),this.cacheLoadedSignal.set(!0)}))}getAnimalById(t){return this.getAnimals().pipe(s(e=>{let i=e.find(a=>a.id_animal===t);return i?.images&&(i.images=i.images.startsWith("http")?i.images:`${this.imageBaseUrl}/${i.images}`),i}))}getHabitatById(t){return this.http.get(`${this.habitatUrl}/${t}`)}addAnimal(t){return this.http.post(this.apiUrl,t).pipe(c(()=>this.clearCache()))}updateAnimal(t){return this.http.put(`${this.apiUrl}/${t.id_animal}`,t).pipe(c(()=>this.clearCache()))}deleteAnimal(t){return this.http.delete(`${this.apiUrl}/${t}`).pipe(c(()=>this.clearCache()))}clearCache(){this.animalsSignal.set([]),this.cacheLoadedSignal.set(!1)}markAnimalAsFed(t,e){return this.http.post(`${this.apiUrl}/${t}/feeding`,v(d({},e),{feedingTime:new Date,animalId:t}))}static \u0275fac=function(e){return new(e||r)(f(h))};static \u0275prov=m({token:r,factory:r.\u0275fac,providedIn:"root"})};var H=class r{apiUrl=`${o.apiUrl}/api/visits`;_visitStats=new y([]);visitStats$=this._visitStats.asObservable();http=n(h);animalService=n(g);habitatService=n(A);serviceService=n(T);tokenService=n($);activeVisits=new Map;constructor(){this.loadStats()}loadStats(){this.getAllStats().subscribe({next:t=>{t&&Array.isArray(t)?t.length>0?this._visitStats.next(t):this.initializeEmptyStats():this.initializeEmptyStats()}})}refreshStats=this.loadStats;initializeEmptyStats(){this.animalService.getAnimals().pipe(u(t=>{let e=t.map(i=>({category_name:i.name,category_type:"animal",visit_count:0,visit_percentage:0,total_duration:0,average_duration:0,last_visit:new Date}));return this.habitatService.getHabitats().pipe(s(i=>({animals:e,habitats:i.map(a=>({category_name:a.name,category_type:"habitat",visit_count:0,visit_percentage:0,total_duration:0,average_duration:0,last_visit:new Date}))})))}),u(({animals:t,habitats:e})=>this.serviceService.getServices().pipe(s(i=>({animals:t,habitats:e,services:i.map(a=>({category_name:a.name,category_type:"service",visit_count:0,visit_percentage:0,total_duration:0,average_duration:0,last_visit:new Date}))}))))).subscribe({next:({animals:t,habitats:e,services:i})=>{console.log("Donn\xE9es r\xE9cup\xE9r\xE9es pour initialisation:",{animalsCount:t.length,habitatsCount:e.length,servicesCount:i.length});let a=[...t,...e,...i];console.log("Statistiques initialis\xE9es:",a),this._visitStats.next(a)},error:t=>{console.error("Erreur lors de l'initialisation des statistiques:",t),this._visitStats.next([])}})}startTracking(t,e,i){let a={categoryName:t,categoryType:e,pageId:i,startTime:new Date};this.activeVisits.set(i,a),console.log(`D\xE9but du tracking pour ${e} ${t}`)}stopTracking(t){let e=this.activeVisits.get(t);e&&(e.endTime=new Date,e.duration=e.endTime.getTime()-e.startTime.getTime(),this.saveVisit(e).subscribe({next:()=>{console.log(`Visite enregistr\xE9e pour ${e.categoryType} ${e.categoryName}`),this.refreshStats()},error:i=>console.error("Erreur lors de l'enregistrement de la visite:",i)}),this.activeVisits.delete(t))}saveVisit(t){return this.http.post(`${this.apiUrl}/track`,t,{headers:this.getHeaders()})}getHeaders(){let t=this.tokenService.getToken();return new S({"Content-Type":"application/json",Authorization:`Bearer ${t}`})}getPublicHeaders(){return new S({"Content-Type":"application/json"})}getAllStats(){return this.http.get(`${this.apiUrl}/stats`,{headers:this.getPublicHeaders()}).pipe(p(t=>(console.error("Erreur lors de la r\xE9cup\xE9ration des stats:",t),l([]))))}getStatsByCategory(t){return this.http.get(`${this.apiUrl}/stats/category/${t}`,{headers:this.getPublicHeaders()}).pipe(p(e=>(console.error("Erreur lors de la r\xE9cup\xE9ration des stats par cat\xE9gorie:",e),l([]))))}getStatsByDateRange(t,e){let i=new V().set("startDate",t.toISOString()).set("endDate",e.toISOString());return this.http.get(`${this.apiUrl}/stats/range`,{params:i,headers:this.getPublicHeaders()}).pipe(p(a=>(console.error("Erreur lors de la r\xE9cup\xE9ration des stats par date:",a),l([]))))}trackVisit(t){return this.http.post(`${this.apiUrl}/track`,t,{headers:this.getHeaders()}).pipe(p(e=>(console.error("Erreur lors du tracking de la visite:",e),l({success:!1,message:"Une erreur est survenue"}))))}static \u0275fac=function(e){return new(e||r)};static \u0275prov=m({token:r,factory:r.\u0275fac,providedIn:"root"})};export{g as a,H as b};
