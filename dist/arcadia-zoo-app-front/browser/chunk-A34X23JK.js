import{a as G}from"./chunk-N6ICPUC7.js";import"./chunk-QMO5IVA6.js";import{a as Y}from"./chunk-VV7GXU3B.js";import{Dc as O,Ec as W,H as w,Hb as l,I as C,Jb as d,Lb as F,Ma as $,Qb as q,Qc as g,Sa as n,Ta as y,V as I,Vb as z,Xb as N,_a as D,a as _,b as x,db as h,hb as j,ia as V,kb as S,lb as L,m as b,mb as c,nb as A,o as R,pb as P,qb as U,rb as s,sa as M,sb as o,ta as T,tb as f,u as v,w as E,xb as k,yb as B,zb as m}from"./chunk-RMHEMJYH.js";function J(a,t){a&1&&(s(0,"div",3),f(1,"div",7),o())}function K(a,t){if(a&1&&(s(0,"div",4),l(1),o()),a&2){let e=m();n(),d(" ",e.error," ")}}function Q(a,t){a&1&&(s(0,"div",5),l(1," Aucun rapport v\xE9t\xE9rinaire disponible. "),o())}function X(a,t){if(a&1&&(s(0,"p",16)(1,"span",17),l(2,"D\xE9tails suppl\xE9mentaires:"),o(),l(3),o()),a&2){let e=m().$implicit;n(3),d(" ",e.additional_details," ")}}function Z(a,t){if(a&1){let e=k();s(0,"div",8)(1,"div",9)(2,"div",10),f(3,"img",11),s(4,"div",12)(5,"div")(6,"h3",13),l(7),o(),s(8,"p",14),l(9),z(10,"date"),o()(),s(11,"div",15)(12,"p",16)(13,"span",17),l(14,"Alimentation recommand\xE9e:"),o(),l(15),o(),h(16,X,4,1,"p",16),s(17,"p",14)(18,"span",17),l(19,"V\xE9t\xE9rinaire:"),o(),l(20),o()()()(),s(21,"div",18)(22,"span",19),f(23,"i"),l(24),o(),s(25,"button",20),B("click",function(){let p=M(e).$implicit,i=m(2);return T(i.toggleReportStatus(p))}),l(26),o()()()()}if(a&2){let e=t.$implicit,r=m(2);n(3),j("src",e.animal_photo,$)("alt",e.animal_name),n(4),d(" Animal: ",e.animal_name," "),n(2),d(" Date de visite: ",N(10,18,e.visit_date,"dd/MM/yyyy")," "),n(6),F(" ",e.recommended_food_quantity,"",e.food_unit," de ",e.recommended_food_type," "),n(),c(e.additional_details?16:-1),n(4),d(" ",e.user_name," "),n(2),S(r.getStateClass(e.animal_state)),n(),L("fas fa-",r.getStateIcon(e.animal_state),""),n(),d(" ",e.animal_state," "),n(),S(e.is_processed?r.getProcessedButtonClass():r.getPendingButtonClass()),n(),d(" ",e.is_processed?"Trait\xE9":"Non trait\xE9"," ")}}function ee(a,t){if(a&1&&(s(0,"div",6),P(1,Z,27,21,"div",8,A),o()),a&2){let e=m();n(),U(e.reports)}}var H=class a{constructor(t,e){this.veterinaryReportsService=t;this.toastService=e}reports=[];isLoading=!0;error=null;currentPage=1;pageSize=10;totalItems=0;latestVeterinaryReport=D(void 0);ngOnInit(){this.loadReports()}loadReports(t=1){this.isLoading=!0,this.veterinaryReportsService.getAllReports(t,this.pageSize).pipe(I(e=>{this.totalItems=e.total;let r=e.data.map(i=>x(_({},i),{id_veterinary_reports:i._id,is_processed:i.is_treated||!1})),p=[...new Set(r.map(i=>i.id_animal))];return R(p).pipe(E(i=>this.veterinaryReportsService.fetchAnimalDetails(i),3),v(i=>r.filter(u=>u.id_animal===i.id_animal).map(u=>x(_({},u),{animal_photo:this.formatImageUrl(i.images),animal_name:i.name}))),C(),v(i=>i.flat()))})).subscribe({next:e=>{this.reports=e,this.isLoading=!1,this.toastService.showSuccess("Rapports charg\xE9s avec succ\xE8s")},error:e=>{this.error="Erreur lors du chargement des rapports",this.isLoading=!1,console.error("Erreur:",e),this.toastService.showError("Erreur lors du chargement des rapports")}})}onPageChange(t){this.currentPage=t,this.loadReports(t)}formatImageUrl(t){return t?t.startsWith("http")?t.replace(`${g.apiUrl}/api/${g.apiUrl}/api/`,`${g.apiUrl}/api/`):`${g.apiUrl}/api/uploads/animals/${t}`:""}getStateClass(t){let e="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-sm font-medium whitespace-nowrap min-w-[140px] justify-center";switch(t.toLowerCase()){case"bonne sant\xE9":return`${e} bg-green-100 text-green-700`;case"malade":return`${e} bg-red-100 text-red-700`;case"en traitement":return`${e} bg-yellow-100 text-yellow-700`;case"en observation":return`${e} bg-blue-100 text-blue-700`;default:return`${e} bg-gray-100 text-gray-700`}}getStateIcon(t){switch(t.toLowerCase()){case"bonne sant\xE9":return"check-circle";case"malade":return"exclamation-circle";case"en traitement":return"clock";case"en observation":return"eye";default:return"information-circle"}}toggleReportStatus(t){let e=t._id??t.id_veterinary_reports;if(!e){this.toastService.showError("ID du rapport non d\xE9fini");return}let r=!t.is_processed;this.veterinaryReportsService.updateReportStatus(e,r).subscribe({next:()=>{t.is_processed=r,t.is_treated=r,this.toastService.showSuccess("Statut du rapport mis \xE0 jour avec succ\xE8s")},error:p=>{console.error("Erreur lors de la mise \xE0 jour du statut:",p),t.is_processed=!r,t.is_treated=!r,this.toastService.showError("Erreur lors de la mise \xE0 jour du statut")}})}getProcessedButtonClass(){return"bg-green-100 text-green-700 hover:bg-green-200"}getPendingButtonClass(){return"bg-yellow-100 text-yellow-700 hover:bg-yellow-200"}loadVeterinaryReports(t){if(!t){console.error("ID animal manquant");return}this.veterinaryReportsService.getAllReports().pipe(v(e=>[...e.data.filter(i=>i.id_animal===t)].sort((i,u)=>new Date(u.visit_date).getTime()-new Date(i.visit_date).getTime())[0]),w(e=>(console.error("Erreur lors du chargement des rapports:",e),this.toastService.showError("Impossible de charger les rapports v\xE9t\xE9rinaires"),b))).subscribe({next:e=>{this.latestVeterinaryReport.set(e||void 0)}})}static \u0275fac=function(e){return new(e||a)(y(G),y(Y))};static \u0275cmp=V({type:a,selectors:[["app-reports-veterinary-management"]],standalone:!0,features:[q],decls:8,vars:4,consts:[[1,"container","mx-auto","px-4","py-8"],[1,"bg-white","rounded-lg","shadow-lg","p-6"],[1,"text-2xl","font-serif","text-tertiary","mb-6"],[1,"flex","justify-center","items-center","py-8"],[1,"bg-red-100","text-red-700","p-4","rounded-lg","mb-6"],[1,"text-center","py-8","text-gray-600"],[1,"grid","grid-cols-1","md:grid-cols-2","gap-6"],[1,"animate-spin","rounded-full","h-8","w-8","border-b-2","border-tertiary"],[1,"bg-gray-50","rounded-lg","p-6","shadow-sm"],[1,"flex","justify-between","items-start"],[1,"flex","items-start","gap-4","w-full"],[1,"w-16","h-16","rounded-full","object-cover",3,"src","alt"],[1,"space-y-4","flex-grow"],[1,"text-lg","font-medium","text-tertiary"],[1,"text-sm","text-gray-600"],[1,"space-y-2"],[1,"text-sm"],[1,"font-medium"],[1,"flex","flex-col","items-end","gap-2"],[1,"ml-2"],[1,"px-3","py-1","rounded-full","text-sm","font-medium","transition-colors",3,"click"]],template:function(e,r){e&1&&(s(0,"div",0)(1,"div",1)(2,"h1",2),l(3," Rapports V\xE9t\xE9rinaires "),o(),h(4,J,2,0,"div",3)(5,K,2,1,"div",4)(6,Q,2,0,"div",5)(7,ee,3,0,"div",6),o()()),e&2&&(n(4),c(r.isLoading?4:-1),n(),c(r.error?5:-1),n(),c(!r.isLoading&&!r.error&&r.reports.length===0?6:-1),n(),c(!r.isLoading&&r.reports.length>0?7:-1))},dependencies:[W,O],encapsulation:2})};export{H as ReportsVeterinaryManagement};
