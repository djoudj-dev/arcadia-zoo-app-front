"use strict";(self.webpackChunkarcadia_zoo_app_front=self.webpackChunkarcadia_zoo_app_front||[]).push([[830],{1871:(E,f,s)=>{s.d(f,{u:()=>t});var _=s(467),v=s(4438);let t=(()=>{class d{ALLOWED_MIME_TYPES=["image/jpeg","image/png","image/webp","image/gif"];MAX_FILE_SIZE=5242880;MAX_IMAGE_DIMENSIONS={width:4096,height:4096};validateFile(u){var c=this;return(0,_.A)(function*(){const p=[];c.ALLOWED_MIME_TYPES.includes(u.type)||p.push("Type de fichier non autoris\xe9. Formats accept\xe9s : JPG, PNG, WebP, GIF"),u.size>c.MAX_FILE_SIZE&&p.push("Le fichier est trop volumineux (maximum 5MB)");try{const l=yield c.getImageDimensions(u);(l.width>c.MAX_IMAGE_DIMENSIONS.width||l.height>c.MAX_IMAGE_DIMENSIONS.height)&&p.push(`Les dimensions de l'image sont trop grandes (max ${c.MAX_IMAGE_DIMENSIONS.width}x${c.MAX_IMAGE_DIMENSIONS.height})`)}catch(l){p.push("Format d'image invalide : "+l.message)}try{(yield c.validateImageContent(u))||p.push("Le contenu du fichier est invalide")}catch(l){p.push(`Impossible de valider le contenu du fichier : ${l.message}`)}return{isValid:0===p.length,errors:p}})()}sanitizeFileName(u){return u.replace(/[^a-zA-Z0-9.-]/g,"_").replace(/\.{2,}/g,".").substring(0,255)}getImageDimensions(u){return new Promise((c,p)=>{const l=new Image;l.onload=()=>{URL.revokeObjectURL(l.src),c({width:l.width,height:l.height})},l.onerror=()=>{URL.revokeObjectURL(l.src),p(new Error("Image invalide"))},l.src=URL.createObjectURL(u)})}validateImageContent(u){return(0,_.A)(function*(){const c=yield u.arrayBuffer(),p=new Uint8Array(c.slice(0,4));return Object.values({jpeg:[255,216,255],png:[137,80,78,71],gif:[71,73,70,56],webp:[82,73,70,70]}).some(h=>h.every((b,x)=>p[x]===b))})()}static \u0275fac=function(c){return new(c||d)};static \u0275prov=v.jDH({token:d,factory:d.\u0275fac,providedIn:"root"})}return d})()},3830:(E,f,s)=>{s.r(f),s.d(f,{HabitatManagementComponent:()=>U});var _=s(467),v=s(177),t=s(4438),d=s(9417),w=s(6029),u=s(5312),c=s(8219),p=s(494),l=s(1626),h=s(8141),b=s(9437),x=s(8810),y=s(1403);let H=(()=>{class o{http;habitatService;apiUrl=`${u.c.apiUrl}/api/admin/habitat-management`;constructor(a,i){this.http=a,this.habitatService=i}getAllHabitats(){return this.http.get(this.apiUrl).pipe((0,h.M)(a=>console.log("Habitats re\xe7us:",a)),(0,b.W)(a=>this.handleError("chargement des habitats",a)))}createHabitat(a){return this.http.post(this.apiUrl,a).pipe((0,h.M)(i=>{console.log("R\xe9ponse du serveur (cr\xe9ation):",i),this.habitatService.clearCache()}),(0,b.W)(i=>(console.error("Erreur d\xe9taill\xe9e (cr\xe9ation):",i),this.handleError("cr\xe9ation de l'habitat",i))))}updateHabitat(a,i){const e=new l.Lr({Accept:"application/json"}),r={};return i.forEach((n,g)=>{r[g]=n}),console.log("Donn\xe9es envoy\xe9es pour mise \xe0 jour:",{id:a,data:r}),this.http.put(`${this.apiUrl}/${a}`,r,{headers:e}).pipe((0,h.M)(n=>{console.log("R\xe9ponse du serveur (mise \xe0 jour):",n),this.habitatService.clearCache()}),(0,b.W)(n=>(console.error("Erreur d\xe9taill\xe9e (mise \xe0 jour):",n),n.error instanceof ErrorEvent?console.error("Erreur client:",n.error.message):console.error("Erreur serveur:",{status:n.status,message:n.message,error:n.error}),this.handleError("mise \xe0 jour de l'habitat",n))))}deleteHabitat(a){return this.http.delete(`${this.apiUrl}/${a}`).pipe((0,h.M)(()=>{console.log("Habitat supprim\xe9 avec succ\xe8s:",a),this.habitatService.clearCache()}),(0,b.W)(i=>(console.error("Erreur lors de la suppression:",i),this.handleError("suppression de l'habitat",i))))}handleError(a,i){let e=`Erreur lors de ${a}. `;return i.error instanceof ErrorEvent?e+=`Message d'erreur: ${i.error.message}`:(e+=`Code d'erreur: ${i.status}, `,e+=`Message: ${i.error?.message||i.message}`),console.error(e),console.error("D\xe9tails complets de l'erreur:",i),(0,x.$)(()=>new Error(e))}static \u0275fac=function(i){return new(i||o)(t.KVO(l.Qq),t.KVO(y.R))};static \u0275prov=t.jDH({token:o,factory:o.\u0275fac,providedIn:"root"})}return o})();var M=s(1593),F=s(9702),D=s(1871);const j=(o,m)=>m.id_habitat;function C(o,m){1&o&&(t.j41(0,"div",17),t.qSk(),t.j41(1,"svg",30),t.nrm(2,"path",31),t.k0s(),t.joV(),t.j41(3,"p",32)(4,"span",33),t.EFF(5,"Cliquez pour t\xe9l\xe9charger"),t.k0s(),t.EFF(6," ou glissez-d\xe9posez "),t.k0s(),t.j41(7,"p",34),t.EFF(8," PNG, JPG ou WEBP (MAX. 5MB) "),t.k0s()())}function S(o,m){if(1&o&&t.nrm(0,"img",18),2&o){const a=t.XpG();t.Y8G("src",a.newHabitatData.images,t.B4B)}}function k(o,m){if(1&o){const a=t.RV6();t.j41(0,"div",35)(1,"p",44),t.EFF(2,"Confirmer la suppression ?"),t.k0s(),t.j41(3,"div",45)(4,"button",46),t.bIt("click",function(){t.eBV(a);const e=t.XpG().$implicit,r=t.XpG();return t.Njj(r.deleteHabitat(e.id_habitat))}),t.EFF(5," Supprimer "),t.k0s(),t.j41(6,"button",47),t.bIt("click",function(){t.eBV(a);const e=t.XpG().$implicit,r=t.XpG();return t.Njj(r.cancelDeleteHabitat(e.id_habitat))}),t.EFF(7," Annuler "),t.k0s()()()}}function I(o,m){if(1&o&&(t.EFF(0),t.nI1(1,"slice")),2&o){const a=t.XpG().$implicit;t.SpI(" ",t.brH(1,1,a.description,0,100),"... ")}}function $(o,m){if(1&o&&t.EFF(0),2&o){const a=t.XpG().$implicit;t.SpI(" ",a.description," ")}}function R(o,m){1&o&&t.EFF(0," Lire la suite ")}function T(o,m){1&o&&t.EFF(0," Voir moins ")}function A(o,m){if(1&o){const a=t.RV6();t.DNE(0,k,8,0,"div",35),t.j41(1,"div",26)(2,"div",36),t.nrm(3,"img",37),t.j41(4,"div",38)(5,"h4",39),t.EFF(6),t.k0s(),t.j41(7,"p",40)(8,"span",33),t.EFF(9,"Description:"),t.k0s(),t.j41(10,"span"),t.DNE(11,I,2,5)(12,$,1,1),t.k0s(),t.j41(13,"button",41),t.bIt("click",function(){const e=t.eBV(a).$implicit,r=t.XpG();return t.Njj(r.toggleDescription(e.id_habitat))}),t.DNE(14,R,1,0)(15,T,1,0),t.k0s()()(),t.j41(16,"div",42)(17,"app-button",43),t.bIt("click",function(){const e=t.eBV(a).$implicit,r=t.XpG();return t.Njj(r.editHabitat(e.id_habitat))})("keydown.enter",function(){const e=t.eBV(a).$implicit,r=t.XpG();return t.Njj(r.editHabitat(e.id_habitat))}),t.k0s(),t.j41(18,"app-button",43),t.bIt("click",function(){const e=t.eBV(a).$implicit,r=t.XpG();return t.Njj(r.confirmDeleteHabitat(e.id_habitat))})("keydown.enter",function(){const e=t.eBV(a).$implicit,r=t.XpG();return t.Njj(r.confirmDeleteHabitat(e.id_habitat))}),t.k0s()()()()}if(2&o){const a=m.$implicit;t.vxM(a.showDeleteConfirmation?0:-1),t.R7$(3),t.Y8G("src",a.images,t.B4B)("alt",a.name),t.R7$(3),t.SpI(" ",a.name," "),t.R7$(5),t.vxM(a.showDescription?12:11),t.R7$(3),t.vxM(a.showDescription?15:14),t.R7$(3),t.Y8G("text","Modifier")("type","button")("color","secondary")("rounded",!0)("customClass","text-xs px-2 py-1"),t.R7$(),t.Y8G("text","Supprimer")("type","button")("color","red")("rounded",!0)("customClass","text-xs px-2 py-1")}}function G(o,m){1&o&&(t.j41(0,"p",27),t.EFF(1," Aucun habitat n'a \xe9t\xe9 cr\xe9\xe9 "),t.k0s())}let U=(()=>{class o{router;habitatManagement;countResourceService;toastService;fileSecurityService;habitats=(0,t.vPA)([]);selectedFile=(0,t.vPA)(null);newHabitatData={};imageBaseUrl=`${u.c.apiUrl}/api`;constructor(a,i,e,r,n){this.router=a,this.habitatManagement=i,this.countResourceService=e,this.toastService=r,this.fileSecurityService=n}ngOnInit(){this.loadHabitats()}loadHabitats(){this.habitatManagement.getAllHabitats().subscribe({next:a=>{const i=e=>e?e.startsWith("http")?e:`${this.imageBaseUrl}/${e.replace(/^\/+/,"")}`:null;this.habitats.set(a.map(e=>({...e,showDescription:!1,showDeleteConfirmation:!1,images:i(e.images)})))},error:a=>{console.error("Erreur lors de la r\xe9cup\xe9ration des habitats:",a),this.toastService.showError("Erreur lors du chargement des habitats")}})}onFileSelected(a){var i=this;return(0,_.A)(function*(){const e=a.target.files?.[0];if(e){i.selectedFile.set(e);const r=new FileReader;r.onload=()=>{i.newHabitatData.images=r.result},r.readAsDataURL(e)}})()}createHabitat(){if(this.validateHabitatData()){const a=this.buildFormData();this.habitatManagement.createHabitat(a).subscribe({next:()=>{this.resetForm(),this.loadHabitats(),this.countResourceService.incrementTotalHabitats(),this.toastService.showSuccess("Habitat cr\xe9\xe9 avec succ\xe8s")},error:i=>{console.error("Erreur lors de la cr\xe9ation de l'habitat :",i),this.toastService.showError("Erreur lors de la cr\xe9ation de l'habitat")}})}else this.toastService.showError("Veuillez remplir tous les champs requis")}updateHabitat(){if(this.validateHabitatData(!0)){const a=this.buildFormData();this.habitatManagement.updateHabitat(this.newHabitatData.id_habitat.toString(),a).subscribe({next:i=>{const r=(n=>n?n.startsWith("http")?n:`${this.imageBaseUrl}/${n.replace(/^\/+/,"")}`:"")(i.images);this.habitats.update(n=>n.map(g=>g.id_habitat===i.id_habitat?{...i,showDescription:g.showDescription,images:r}:g)),this.resetForm(),this.toastService.showSuccess("Habitat mis \xe0 jour avec succ\xe8s"),this.loadHabitats()},error:i=>{console.error("Erreur lors de la mise \xe0 jour de l'habitat :",i),this.toastService.showError("Erreur lors de la mise \xe0 jour de l'habitat")}})}else this.toastService.showError("Veuillez remplir tous les champs requis")}editHabitat(a){const i=this.habitats().find(e=>e.id_habitat===a);i&&(this.newHabitatData={...i},this.toastService.showSuccess("Habitat s\xe9lectionn\xe9 pour modification"))}confirmDeleteHabitat(a){this.habitats.update(i=>i.map(e=>e.id_habitat===a?{...e,showDeleteConfirmation:!0}:e))}cancelDeleteHabitat(a){this.habitats.update(i=>i.map(e=>e.id_habitat===a?{...e,showDeleteConfirmation:!1}:e))}deleteHabitat(a){a?this.habitatManagement.deleteHabitat(a.toString()).subscribe({next:()=>{this.habitats.update(i=>i.filter(e=>e.id_habitat!==a)),this.countResourceService.decrementTotalHabitats(),this.loadHabitats(),this.resetForm(),this.toastService.showSuccess("Habitat supprim\xe9 avec succ\xe8s")},error:i=>{console.error("Erreur lors de la suppression de l'habitat:",i),this.toastService.showError("Erreur lors de la suppression de l'habitat")}}):this.toastService.showError("ID d'habitat invalide")}resetForm(){this.newHabitatData={},this.selectedFile.set(null)}cancel(){this.resetForm(),this.toastService.showSuccess("Formulaire r\xe9initialis\xe9")}toggleDescription(a){this.habitats.update(i=>i.map(e=>e.id_habitat===a?{...e,showDescription:!e.showDescription}:e))}goBack(){this.router.navigate(["/admin"])}validateHabitatData(a=!1){const{name:i,description:e}=this.newHabitatData,r=a||this.newHabitatData.images||this.selectedFile();return console.log("Validation des donn\xe9es:",{name:i,description:e,hasImage:r,newHabitatData:this.newHabitatData,selectedFile:this.selectedFile()}),!!(i&&e&&r)}buildFormData(){const a=new FormData;Object.entries(this.newHabitatData).forEach(([r,n])=>{null!=n&&a.append(r,n.toString())});const e=this.selectedFile();if(e){const r=this.fileSecurityService.sanitizeFileName(e.name);a.append("images",e,r)}return a}static \u0275fac=function(i){return new(i||o)(t.rXU(p.Ix),t.rXU(H),t.rXU(M.v),t.rXU(F.f),t.rXU(D.u))};static \u0275cmp=t.VBU({type:o,selectors:[["app-habitat-management"]],standalone:!0,features:[t.aNF],decls:42,vars:17,consts:[[1,"w-full","bg-gradient-to-b","from-secondary","to-primary","shadow-lg","py-8"],[1,"container","mx-auto","px-4"],[1,"text-center","space-y-4","mb-12"],[1,"text-3xl","md:text-5xl","lg:text-6xl","font-serif","font-bold","text-quinary"],[1,"text-lg","md:text-xl","text-tertiary","font-serif","italic","max-w-4xl","mx-auto"],[1,"flex","flex-col","lg:flex-row","gap-8"],[1,"w-full","lg:w-1/2","bg-white","rounded-2xl","shadow-lg","p-6","space-y-6"],[1,"text-2xl","font-serif","font-semibold","text-tertiary","mb-6"],["enctype","multipart/form-data",1,"space-y-6",3,"ngSubmit"],["for","name",1,"block","text-lg","font-medium","text-tertiary","mb-2"],["type","text","id","name","name","name","required","","placeholder","Nom de l'habitat",1,"w-full","p-3","border","border-secondary/30","rounded-lg","focus:ring-2","focus:ring-tertiary","focus:border-transparent",3,"ngModelChange","ngModel"],["for","description",1,"block","text-lg","font-medium","text-tertiary","mb-2"],["id","description","name","description","required","","rows","4","placeholder","Description de l'habitat",1,"w-full","p-3","border","border-secondary/30","rounded-lg","focus:ring-2","focus:ring-tertiary","focus:border-transparent",3,"ngModelChange","ngModel"],[1,"mb-4"],["for","habitatImage",1,"block","text-sm","font-medium","text-gray-700","mb-2"],[1,"flex","items-center","justify-center","w-full"],[1,"flex","flex-col","items-center","justify-center","w-full","h-64","border-2","border-gray-300","border-dashed","rounded-lg","cursor-pointer","bg-gray-50","hover:bg-gray-100","transition-all","duration-300"],[1,"flex","flex-col","items-center","justify-center","pt-5","pb-6"],["alt","Aper\xe7u",1,"w-full","h-full","object-cover","rounded-lg",3,"src"],["id","habitatImage","type","file","accept","image/*",1,"hidden",3,"change"],[1,"flex","gap-4","pt-4"],[1,"w-1/2",3,"text","type","color","rounded"],[1,"w-1/2",3,"click","keydown.enter","text","type","color","rounded"],[1,"w-full","lg:w-1/2","space-y-8"],[1,"bg-white","rounded-2xl","shadow-lg","p-6"],[1,"space-y-4"],[1,"bg-gray-50","rounded-xl","p-4","shadow-md","hover:shadow-lg","transition-all","duration-300"],[1,"text-center","text-gray-500","italic"],[1,"flex","justify-center","pt-8"],[1,"w-full","sm:w-1/3","lg:w-1/4","font-bold","shadow-md","hover:shadow-lg","transition-all","duration-300",3,"click","keydown.enter","text","type","color","rounded"],["aria-hidden","true","xmlns","http://www.w3.org/2000/svg","fill","none","viewBox","0 0 20 16",1,"w-8","h-8","mb-4","text-gray-500"],["stroke","currentColor","stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"],[1,"mb-2","text-sm","text-gray-500"],[1,"font-semibold"],[1,"text-xs","text-gray-500"],[1,"mt-4"],[1,"flex","flex-col","sm:flex-row","items-center","gap-4"],[1,"w-32","h-32","object-cover","rounded-lg","shadow-md",3,"src","alt"],[1,"flex-1","space-y-2"],[1,"text-lg","font-bold","text-tertiary"],[1,"text-sm","text-gray-600"],[1,"text-tertiary","hover:text-tertiary/80","ml-2","underline",3,"click"],[1,"flex","gap-2"],[3,"click","keydown.enter","text","type","color","rounded","customClass"],[1,"text-gray-800"],[1,"flex","justify-end","gap-2","mt-2"],[1,"px-4","py-2","bg-red-500","text-white","rounded","hover:bg-red-600",3,"click"],[1,"px-4","py-2","bg-gray-300","text-gray-700","rounded","hover:bg-gray-400",3,"click"]],template:function(i,e){1&i&&(t.j41(0,"section",0)(1,"div",1)(2,"div",2)(3,"h1",3),t.EFF(4," Gestion des Habitats "),t.k0s(),t.j41(5,"p",4),t.EFF(6," Cr\xe9ez et g\xe9rez les habitats du zoo "),t.k0s()(),t.j41(7,"div",5)(8,"div",6)(9,"h3",7),t.EFF(10),t.k0s(),t.j41(11,"form",8),t.bIt("ngSubmit",function(){return e.newHabitatData.id_habitat?e.updateHabitat():e.createHabitat()}),t.j41(12,"div")(13,"label",9),t.EFF(14," Nom de l'habitat "),t.k0s(),t.j41(15,"input",10),t.mxI("ngModelChange",function(n){return t.DH7(e.newHabitatData.name,n)||(e.newHabitatData.name=n),n}),t.k0s()(),t.j41(16,"div")(17,"label",11),t.EFF(18," Description "),t.k0s(),t.j41(19,"textarea",12),t.mxI("ngModelChange",function(n){return t.DH7(e.newHabitatData.description,n)||(e.newHabitatData.description=n),n}),t.k0s()(),t.j41(20,"div",13)(21,"label",14),t.EFF(22," Image de l'habitat "),t.k0s(),t.j41(23,"div",15)(24,"label",16),t.DNE(25,C,9,0,"div",17)(26,S,1,1,"img",18),t.j41(27,"input",19),t.bIt("change",function(n){return e.onFileSelected(n)}),t.k0s()()()(),t.j41(28,"div",20),t.nrm(29,"app-button",21),t.j41(30,"app-button",22),t.bIt("click",function(){return e.cancel()})("keydown.enter",function(){return e.cancel()}),t.k0s()()()(),t.j41(31,"div",23)(32,"div",24)(33,"h3",7),t.EFF(34," Liste des habitats "),t.k0s(),t.j41(35,"div",25),t.nrm(36,"app-toast"),t.Z7z(37,A,19,16,"div",26,j),t.DNE(39,G,2,0,"p",27),t.k0s()()()(),t.j41(40,"div",28)(41,"app-button",29),t.bIt("click",function(){return e.goBack()})("keydown.enter",function(){return e.goBack()}),t.k0s()()()()),2&i&&(t.R7$(10),t.SpI(" ",e.newHabitatData.id_habitat?"Modifier l'habitat":"Cr\xe9er un habitat"," "),t.R7$(5),t.R50("ngModel",e.newHabitatData.name),t.R7$(4),t.R50("ngModel",e.newHabitatData.description),t.R7$(6),t.vxM(e.newHabitatData.images?26:25),t.R7$(4),t.Y8G("text",e.newHabitatData.id_habitat?"Modifier":"Cr\xe9er")("type","submit")("color","tertiary")("rounded",!0),t.R7$(),t.Y8G("text","Annuler")("type","button")("color","secondary")("rounded",!0),t.R7$(7),t.Dyx(e.habitats()),t.R7$(2),t.vxM(e.habitats().length?-1:39),t.R7$(2),t.Y8G("text","Retour")("type","button")("color","tertiary")("rounded",!0))},dependencies:[d.X1,d.qT,d.me,d.BC,d.cb,d.YS,d.YN,d.vS,d.cV,v.P9,w.d,c.Q],encapsulation:2})}return o})()}}]);