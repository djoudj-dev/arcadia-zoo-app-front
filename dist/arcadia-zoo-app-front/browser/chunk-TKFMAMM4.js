import{a as y}from"./chunk-2CBPXYGN.js";import{a as f}from"./chunk-TTATSR4U.js";import{G as n,Qc as h,R as d,Rc as g,Tc as b,V as c,Wc as i,Y as m,aa as u,ba as v,p as o,u as l}from"./chunk-JLM7LPRF.js";var R=class p{constructor(e,r){this.tokenService=e;this.toastService=r}apiUrl=`${i.apiUrl}/api/veterinary/reports`;animalApiUrl=`${i.apiUrl}/api/animals`;http=v(b);animalCache=new Map;cacheTimeout=300*1e3;lastCacheUpdate=new Map;getAuthHeaders(){let e=this.tokenService.getToken();return console.log("Token r\xE9cup\xE9r\xE9:",e?"pr\xE9sent":"null"),e||(console.warn("Aucun token trouv\xE9 dans le sessionStorage"),this.toastService.showError("Votre session a expir\xE9, veuillez vous reconnecter")),new h({"Content-Type":"application/json",Authorization:`Bearer ${e}`})}getPublicHeaders(){return new h({"Content-Type":"application/json"})}getAllReports(e=1,r=10){let t=new g().set("page",e.toString()).set("limit",r.toString());return this.http.get(this.apiUrl,{params:t,headers:this.getPublicHeaders()}).pipe(l(a=>a?{data:a.data||[],total:a.total||0}:{data:[],total:0}),n(a=>(console.error("Erreur lors de la r\xE9cup\xE9ration des rapports:",a),this.toastService.showError("Erreur lors du chargement des rapports"),o({data:[],total:0}))))}getReportById(e){let r=this.getPublicHeaders();return this.http.get(`${this.apiUrl}/${e}`,{headers:r})}createReport(e){return this.http.post(this.apiUrl,e,{headers:this.getAuthHeaders()})}updateReport(e,r){let t=this.getAuthHeaders();return this.http.put(`${this.apiUrl}/${e}`,r,{headers:t})}deleteReport(e){return this.http.delete(`${this.apiUrl}/${e}`,{headers:this.getAuthHeaders()})}fetchAnimalDetails(e){let r=this.animalCache.get(e),t=this.lastCacheUpdate.get(e),a=Date.now();return r&&t&&a-t<this.cacheTimeout?o(r):this.http.get(`${this.animalApiUrl}/${e}`,{headers:this.getPublicHeaders()}).pipe(c(s=>{this.animalCache.set(e,s),this.lastCacheUpdate.set(e,a)}),n(s=>{throw console.error("Erreur lors de la r\xE9cup\xE9ration de l'animal:",s),this.toastService.showError("Impossible de r\xE9cup\xE9rer les informations de l'animal"),s}),d(1))}updateReportStatus(e,r){let t=this.getAuthHeaders();return this.http.patch(`${this.apiUrl}/${e}/status`,{is_treated:r},{headers:t})}getReportsByAnimalId(e){console.log(`Tentative de r\xE9cup\xE9ration des rapports pour l'animal ${e}`);let r=`${this.apiUrl}/animal/${e}`;return console.log("URL appel\xE9e:",r),this.http.get(r,{headers:this.getPublicHeaders()}).pipe(c(t=>{console.log(`Rapports re\xE7us pour l'animal ${e}:`,t)}),l(t=>[...t].sort((s,U)=>new Date(U.visit_date).getTime()-new Date(s.visit_date).getTime())),n(t=>{console.error("Erreur lors de la r\xE9cup\xE9ration des rapports v\xE9t\xE9rinaires:",t),console.error("D\xE9tails de l'erreur:",{status:t.status,statusText:t.statusText,message:t.message,url:t.url,error:t.error});let a="Impossible de charger les rapports v\xE9t\xE9rinaires pour cet animal";return t.status===404?a="Aucun rapport trouv\xE9 pour cet animal":t.status===401&&(a="Votre session a expir\xE9, veuillez vous reconnecter"),this.toastService.showError(a),o([])}))}formatImageUrl(e){if(!e)return"";if(e.startsWith("http"))return e.replace(`${i.apiUrl}/api/`,`${i.apiUrl}/api/`);let r=e.replace(/^uploads\/animals\//,"");return`${i.apiUrl}/api/uploads/animals/${r}`}clearCache(e){e?(this.animalCache.delete(e),this.lastCacheUpdate.delete(e)):(this.animalCache.clear(),this.lastCacheUpdate.clear())}static \u0275fac=function(r){return new(r||p)(u(y),u(f))};static \u0275prov=m({token:p,factory:p.\u0275fac,providedIn:"root"})};export{R as a};
