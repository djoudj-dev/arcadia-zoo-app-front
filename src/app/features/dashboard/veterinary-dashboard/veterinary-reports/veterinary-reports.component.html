<div class="w-full max-w-2xl mx-auto bg-white p-6 rounded-xl">
  <app-toast />

  <!-- En-tête avec titre et bouton de fermeture -->
  <div class="flex justify-between items-center mb-8">
    <h2 class="text-2xl font-serif text-tertiary">Nouveau Rapport</h2>
    <button
      (click)="closeModal()"
      class="rounded-full p-2 hover:bg-tertiary/10 transition-colors"
    >
      <svg
        class="w-6 h-6 text-tertiary"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="1.5"
          d="M6 18L18 6M6 6l12 12"
        />
      </svg>
    </button>
  </div>

  <form [formGroup]="reportForm" (ngSubmit)="onSubmit()" class="space-y-6">
    <!-- Information de l'animal -->
    <div class="mb-6">
      <label
        class="block text-sm font-medium text-quinary/60 mb-2"
        for="animal-name"
        >Animal</label
      >
      <input
        id="animal-name"
        type="text"
        [formControl]="$any(reportForm.get('animal_name'))"
        readonly
        class="w-full p-2 bg-transparent border-b-2 border-tertiary/20 text-lg text-tertiary font-medium focus:outline-none"
      />
    </div>

    <!-- État de santé -->
    <div class="mb-6">
      <label
        class="block text-lg font-medium text-tertiary mb-2"
        for="health-state"
      >
        État de santé de l'animal
      </label>
      <select
        id="health-state"
        [ngModel]="selectedState()"
        (ngModelChange)="selectedState.set($event)"
        (change)="updateHealthState()"
        class="w-full p-3 border border-secondary/30 rounded-lg focus:ring-2 focus:ring-tertiary focus:border-transparent"
      >
        <option [value]="AnimalState.GOOD_HEALTH">Bonne santé</option>
        <option [value]="AnimalState.INJURED">Blessé</option>
        <option [value]="AnimalState.SICK">Malade</option>
      </select>
    </div>

    <!-- Date et État -->
    <div class="grid grid-cols-2 gap-6 mb-6">
      <div>
        <label
          class="block text-sm font-medium text-quinary/60 mb-2"
          for="visit-date"
          >Date de visite</label
        >
        <input
          id="visit-date"
          type="date"
          [formControl]="$any(reportForm.get('visit_date'))"
          class="w-full p-2 bg-transparent border-b-2 border-tertiary/20 focus:border-tertiary transition-colors focus:outline-none"
        />
      </div>

      <div>
        <label
          class="block text-sm font-medium text-quinary/60 mb-2"
          for="animal-state"
          >État de santé</label
        >
        <select
          id="animal-state"
          [formControl]="$any(reportForm.get('animal_state'))"
          class="w-full p-2 bg-transparent border-b-2 border-tertiary/20 focus:border-tertiary transition-colors focus:outline-none appearance-none cursor-pointer"
        >
          <option value="" disabled selected>Choisir un état</option>
          @for (state of animalStates; track state) {
          <option [value]="state">{{ state }}</option>
          }
        </select>
      </div>
    </div>

    <!-- Recommandations alimentaires -->
    <div class="space-y-6">
      <h3 class="text-lg font-medium text-tertiary">
        Recommandations alimentaires
      </h3>

      <div>
        <label
          class="block text-sm font-medium text-quinary/60 mb-2"
          for="food-type"
          >Type d'alimentation</label
        >
        <input
          id="food-type"
          type="text"
          [formControl]="$any(reportForm.get('recommended_food_type'))"
          class="w-full p-2 bg-transparent border-b-2 border-tertiary/20 focus:border-tertiary transition-colors focus:outline-none"
          placeholder="Ex: Croquettes premium"
        />
      </div>

      <div class="grid grid-cols-2 gap-6">
        <div>
          <label
            class="block text-sm font-medium text-quinary/60 mb-2"
            for="food-quantity"
            >Quantité</label
          >
          <input
            id="food-quantity"
            type="number"
            [formControl]="$any(reportForm.get('recommended_food_quantity'))"
            class="w-full p-2 bg-transparent border-b-2 border-tertiary/20 focus:border-tertiary transition-colors focus:outline-none"
            placeholder="Ex: 250"
          />
        </div>

        <div>
          <label
            class="block text-sm font-medium text-quinary/60 mb-2"
            for="food-unit"
            >Unité</label
          >
          <select
            id="food-unit"
            [formControl]="$any(reportForm.get('food_unit'))"
            class="w-full p-2 bg-transparent border-b-2 border-tertiary/20 focus:border-tertiary transition-colors focus:outline-none appearance-none cursor-pointer"
          >
            <option value="" disabled selected>Choisir une unité</option>
            @for (unit of foodUnits; track unit) {
            <option [value]="unit">{{ unit }}</option>
            }
          </select>
        </div>
      </div>
    </div>

    <!-- Observations -->
    <div>
      <label
        class="block text-sm font-medium text-quinary/60 mb-2"
        for="observations"
        >Observations</label
      >
      <textarea
        id="observations"
        [formControl]="$any(reportForm.get('additional_details'))"
        rows="4"
        class="w-full p-4 bg-tertiary/5 rounded-lg focus:outline-none focus:ring-1 focus:ring-tertiary/30 transition-all resize-none"
        placeholder="Ajoutez des observations complémentaires..."
      ></textarea>
    </div>

    <!-- Boutons d'action -->
    <div class="flex justify-end gap-4 pt-6">
      <app-button
        [text]="'Annuler'"
        [type]="'button'"
        [color]="'secondary'"
        [customClass]="'px-6 py-2 rounded-lg hover:bg-gray-100'"
        (click)="closeModal()"
        (keydown)="closeModal()"
      />
      <app-button
        [text]="'Enregistrer'"
        [type]="'submit'"
        [color]="'tertiary'"
        [disabled]="!reportForm.valid"
        [customClass]="'px-6 py-2 rounded-lg'"
        (keydown)="onSubmit()"
      />
    </div>
  </form>
</div>

<!-- Style pour les inputs -->
<style>
  input::placeholder,
  textarea::placeholder {
    color: rgba(85, 122, 70, 0.4);
  }

  input:focus::placeholder,
  textarea:focus::placeholder {
    color: rgba(85, 122, 70, 0.6);
  }

  select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23557A46'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E");
    background-position: right 0.5rem center;
    background-repeat: no-repeat;
    background-size: 1.5em 1.5em;
    padding-right: 2.5rem;
  }
</style>

<!-- En-tête avec onglets -->
<div class="flex space-x-4 mb-6">
  <button
    (click)="activeTab.set('feeding')"
    [class]="
      activeTab() === 'feeding'
        ? 'bg-tertiary text-white'
        : 'bg-tertiary/10 text-tertiary'
    "
    class="px-4 py-2 rounded-lg transition-colors"
  >
    Historique des repas
  </button>
  <button
    (click)="activeTab.set('veterinary')"
    [class]="
      activeTab() === 'veterinary'
        ? 'bg-tertiary text-white'
        : 'bg-tertiary/10 text-tertiary'
    "
    class="px-4 py-2 rounded-lg transition-colors"
  >
    Rapports vétérinaires
  </button>
</div>

<!-- Historique des passages vétérinaires -->
@if (activeTab() === 'veterinary') {
<div class="space-y-4">
  @for (report of veterinaryReports(); track report._id) {
  <div class="bg-white p-4 rounded-lg shadow border border-tertiary/10">
    <div class="flex justify-between items-start mb-2">
      <div>
        <span class="text-sm text-quinary/60">
          {{ report.visit_date | date : "dd/MM/yyyy HH:mm" }}
        </span>
        <p class="font-medium text-tertiary">Dr. {{ report.user_name }}</p>
      </div>
      <span [class]="getStateClass(report.animal_state)">
        {{ report.animal_state }}
      </span>
    </div>
    <div class="mt-3 space-y-2">
      <p class="text-sm text-tertiary">
        <span class="font-medium">Alimentation recommandée:</span>
        {{ report.recommended_food_type }} -
        {{ report.recommended_food_quantity }}{{ report.food_unit }}
      </p>
      @if (report.additional_details) {
      <p class="text-sm text-tertiary/80 italic">
        "{{ report.additional_details }}"
      </p>
      }
    </div>
  </div>
  }
</div>
}

<!-- Historique des repas -->
@if (activeTab() === 'feeding') {
<div class="space-y-4">
  @for (feeding of feedingHistory(); track feeding.id) {
  <div class="bg-white p-4 rounded-lg shadow border border-tertiary/10">
    <div class="flex justify-between items-start">
      <div>
        <span class="text-sm text-quinary/60">
          {{ feeding.date | date : "dd/MM/yyyy HH:mm" }}
        </span>
        <p class="font-medium text-tertiary">{{ feeding.food_type }}</p>
      </div>
      <span class="text-sm font-medium text-tertiary">
        {{ feeding.quantity }}{{ feeding.unit }}
      </span>
    </div>
    @if (feeding.notes) {
    <p class="mt-2 text-sm text-tertiary/80 italic">"{{ feeding.notes }}"</p>
    }
  </div>
  }
</div>
}
