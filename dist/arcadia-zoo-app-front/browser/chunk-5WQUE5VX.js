import{Tc as u,Wc as t,Y as o,aa as p,d as a,t as l}from"./chunk-JLM7LPRF.js";var c=class extends Error{constructor(e){super(e),this.name="FileValidationError"}},d=class s{constructor(e){this.http=e}config={MIME_TYPES:["image/jpeg","image/png","image/webp","image/gif"],MAX_FILE_SIZE:5*1024*1024,MAX_DIMENSIONS:{width:4096,height:4096},THREAT_PATTERNS:{SIGNATURES:new Set(["4D5A","FFD8FF","526172"]),DANGEROUS_EXTENSIONS:new Set([".exe",".bat",".cmd",".sh",".php"])}};scan(e){return a(this,null,function*(){try{if(!this.config.MIME_TYPES.includes(e.type))throw new c("Type de fichier non autoris\xE9");let i=new FormData;return i.append("file",e),yield l(this.http.post(`${t.apiUrl}/security/scan`,i))}catch(i){return i instanceof c?{isSafe:!1,threats:[i.message]}:(console.warn("Scan antivirus non disponible:",i),{isSafe:!0,threats:[]})}})}isImage(e){return e.type.startsWith("image/")}validateImageContent(e,i){return a(this,null,function*(){if(this.isImage(e)){let[r,n]=yield Promise.all([this.checkFileHeader(e),this.validateDimensions(e)]);r.isValid||i.push("Contenu d'image invalide ou corrompu"),n.isValid||i.push("Dimensions de l'image non autoris\xE9es")}})}checkFileHeader(e){return a(this,null,function*(){try{let i=yield e.slice(0,8).arrayBuffer(),r=Array.from(new Uint8Array(i)).map(m=>m.toString(16).padStart(2,"0")).join("").toUpperCase();return{isValid:!this.config.THREAT_PATTERNS.SIGNATURES.has(r)}}catch{return{isValid:!1}}})}validateDimensions(e){return a(this,null,function*(){if(!this.isImage(e))return{isValid:!0};try{let i=yield this.loadImage(e);return{isValid:i.width<=this.config.MAX_DIMENSIONS.width&&i.height<=this.config.MAX_DIMENSIONS.height}}catch{return{isValid:!1}}})}loadImage(e){return new Promise((i,r)=>{let n=new Image;n.onload=()=>i(n),n.onerror=()=>r(new Error("Chargement de l'image \xE9chou\xE9")),n.src=URL.createObjectURL(e)})}static \u0275fac=function(i){return new(i||s)(p(u))};static \u0275prov=o({token:s,factory:s.\u0275fac,providedIn:"root"})};var f=class s{getImageUrl(e){return e?e.startsWith("http://")||e.startsWith("https://")?e:t.s3?.enabled?e.includes("/")?`${t.s3.baseUrl}/${e}`:`${t.s3.baseUrl}/uploads/${e}`:e.startsWith("uploads/")?`${t.apiUrl}/api/${e}`:`${t.apiUrl}/api/uploads/${e}`:"/assets/images/placeholder.jpg"}isValidImagePath(e){if(!e)return!1;let i=[".jpg",".jpeg",".png",".gif",".webp"],r=e.toLowerCase();return i.some(n=>r.includes(n))}transformToS3Url(e,i){if(!t.s3?.enabled)return e;let r=e.split("/").pop()||e;return`${t.s3.baseUrl}/${i}/${r}`}static \u0275fac=function(i){return new(i||s)};static \u0275prov=o({token:s,factory:s.\u0275fac,providedIn:"root"})};export{d as a,f as b};
