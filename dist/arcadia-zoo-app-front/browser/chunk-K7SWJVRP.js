import{a as he}from"./chunk-Q36X3LJI.js";import{a as ue}from"./chunk-5VXZOEXZ.js";import{a as Y}from"./chunk-3PZTUIRH.js";import{a as _e}from"./chunk-AJHSUSCG.js";import{a as pe}from"./chunk-4RXGQP6I.js";import{c as Z,e as ee,f as te,h as ie,j as ne,k as ae,p as re,q as oe,r as le,t as se,v as me,w as ce}from"./chunk-XTDWMBHN.js";import{a as ge}from"./chunk-JTG5FMLG.js";import{a as de}from"./chunk-D7JCWFOM.js";import{Ab as j,Db as G,E as M,Ea as $,Gb as J,Ja as m,Ka as S,Pa as f,S as D,Sb as X,Ua as b,V as N,Ya as g,_ as I,a as h,ab as x,b as C,ba as q,c as L,db as T,eb as k,ec as K,fb as r,gb as o,hb as E,ib as V,jb as _,kb as c,kc as B,la as u,lc as Q,ma as p,na as P,o as F,oa as U,oc as R,qb as s,rb as W,sb as v,vb as w,wb as A,xb as y,zb as z}from"./chunk-OS3QXM5S.js";var H=class l{constructor(i,e){this.http=i;this.animalService=e}apiUrl=`${R.apiUrl}/api/admin/animal-management`;getAllAnimals(){return this.http.get(this.apiUrl).pipe(M(i=>this.handleError("chargement des animaux",i)))}createAnimal(i){let e=new B({Accept:"application/json"}),t={};return i.forEach((a,n)=>{n==="weightRange"?t.weight_range=a:t[n]=a}),this.http.post(this.apiUrl,t,{headers:e}).pipe(D(()=>this.animalService.clearCache()),M(a=>this.handleError("cr\xE9ation de l'animal",a)))}updateAnimal(i,e){if(!i||!e)return F(()=>new Error("Donn\xE9es invalides"));let t=new B({Accept:"application/json"}),a={};return e.forEach((n,d)=>{d==="weightRange"?a.weight_range=n:a[d]=n}),console.log("Donn\xE9es envoy\xE9es pour mise \xE0 jour:",{id:i,data:a}),this.http.put(`${this.apiUrl}/${i}`,a,{headers:t}).pipe(D(n=>{console.log("R\xE9ponse du serveur (mise \xE0 jour):",n),this.animalService.clearCache()}),M(n=>(console.error("Erreur d\xE9taill\xE9e (mise \xE0 jour):",n),n.status===413?F(()=>new Error("Fichier trop volumineux")):this.handleError("mise \xE0 jour de l'animal",n))))}deleteAnimal(i){return this.http.delete(`${this.apiUrl}/${i}`).pipe(D(()=>this.animalService.clearCache()),M(e=>this.handleError("suppression de l'animal",e)))}handleError(i,e){let t=`Erreur lors de ${i}: `;return e.error instanceof ErrorEvent?t+=`Une erreur est survenue: ${e.error.message}`:(t+=`Le serveur a retourn\xE9: ${e.status} - ${e.statusText}`,e.error?.message&&(t+=`
D\xE9tail: ${e.error.message}`)),console.error(t),F(()=>new Error(t))}static \u0275fac=function(e){return new(e||l)(I(Q),I(_e))};static \u0275prov=N({token:l,factory:l.\u0275fac,providedIn:"root"})};var fe=(l,i)=>i.id_habitat,we=(l,i)=>i.id_animal,O=()=>[];function Ae(l,i){l&1&&(r(0,"div",17),P(),r(1,"svg",38),E(2,"path",39),o(),U(),r(3,"p",40)(4,"span",41),s(5,"Cliquez pour t\xE9l\xE9charger"),o(),s(6," ou glissez-d\xE9posez "),o(),r(7,"p",42),s(8," PNG, JPG ou WEBP (MAX. 5MB) "),o()())}function ye(l,i){if(l&1&&E(0,"img",18),l&2){let e=c();g("src",e.newAnimalData().images,$)}}function Ce(l,i){if(l&1&&(r(0,"option",23),s(1),o()),l&2){let e=i.$implicit;g("value",e.id_habitat),m(),W(e.name)}}function Se(l,i){if(l&1&&(s(0),G(1,"slice")),l&2){let e=c(2).$implicit;v(" ",J(1,1,e.characteristics,0,30),"... ")}}function Ee(l,i){if(l&1&&s(0),l&2){let e=c(2).$implicit;v(" ",e.characteristics," ")}}function Me(l,i){l&1&&s(0," Lire la suite ")}function Fe(l,i){l&1&&s(0," Voir moins ")}function De(l,i){if(l&1){let e=V();r(0,"div",57)(1,"p"),s(2),o(),r(3,"div",58)(4,"button",59),_("click",function(){u(e);let a=c(4);return p(a.deleteAnimalConfirmed())}),s(5," Supprimer "),o(),r(6,"button",60),_("click",function(){u(e);let a=c(4);return p(a.cancelDelete())}),s(7," Annuler "),o()()()}if(l&2){let e=c(2).$implicit;m(2),v(` \xCAtes-vous s\xFBr de vouloir supprimer l'animal "`,e.name,'" ? ')}}function Te(l,i){if(l&1){let e=V();r(0,"div",47)(1,"div",48),E(2,"img",49),r(3,"div",50)(4,"h4",51),s(5),o(),r(6,"p",52),s(7),o(),r(8,"p",53)(9,"span",41),s(10,"Description:"),o(),r(11,"span"),b(12,Se,2,5)(13,Ee,1,1),o(),r(14,"button",54),_("click",function(){u(e);let a=c().$implicit,n=c(2);return p(n.toggleAnimal(a.id_animal))}),b(15,Me,1,0)(16,Fe,1,0),o()()(),r(17,"div",55)(18,"app-button",56),_("click",function(){u(e);let a=c().$implicit,n=c(2);return p(n.editAnimal(a.id_animal))})("keydown",function(a){u(e);let n=c().$implicit,d=c(2);return p(a.key==="Enter"&&d.editAnimal(n.id_animal))}),o(),r(19,"app-button",56),_("click",function(){u(e);let a=c().$implicit,n=c(2);return p(n.confirmDeleteAnimal(a.id_animal))})("keydown",function(a){u(e);let n=c().$implicit,d=c(2);return p(a.key==="Enter"&&d.confirmDeleteAnimal(n.id_animal))}),o()()(),b(20,De,8,1,"div",57),o()}if(l&2){let e=c().$implicit,t=c(2);m(2),g("src",e.images,$)("alt",e.name),m(3),v(" ",e.name," "),m(2),W(e.species),m(5),x(e.showTime?13:12),m(3),x(e.showTime?16:15),m(3),g("text","Modifier")("type","button")("color","secondary")("rounded",!0)("customClass","text-xs px-2 py-1"),m(),g("text","Supprimer")("type","button")("color","red")("rounded",!0)("customClass","text-xs px-2 py-1"),m(),x(t.animalToDelete===e.id_animal?20:-1)}}function ke(l,i){if(l&1&&b(0,Te,21,17,"div",47),l&2){let e=i.$implicit,t=c().$implicit,a=c();x(a.visibleAnimals()[t.id_habitat]||a.groupedAnimals()[t.id_habitat].indexOf(e)===0?0:-1)}}function Ve(l,i){if(l&1){let e=V();r(0,"div",45)(1,"app-button",56),_("click",function(){u(e);let a=c().$implicit,n=c();return p(n.toggleVisibility(a.id_habitat))})("keydown",function(a){u(e);let n=c().$implicit,d=c();return p(a.key==="Enter"&&d.toggleVisibility(n.id_habitat))}),o()()}if(l&2){let e=c().$implicit,t=c();m(),g("text",t.visibleAnimals()[e.id_habitat]?"Voir moins":"Voir plus")("type","button")("color","tertiary")("rounded",!0)("customClass","px-4 py-2")}}function je(l,i){l&1&&(r(0,"p",46),s(1," Aucun animal dans cet habitat "),o())}function Re(l,i){if(l&1&&(r(0,"div",37)(1,"h3",43),s(2),o(),r(3,"div",44),T(4,ke,1,1,null,null,we),b(6,Ve,2,5,"div",45)(7,je,2,0,"p",46),o()()),l&2){let e=i.$implicit,t=c();m(2),v(" ",e.name," "),m(2),k(t.groupedAnimals()[e.id_habitat]||j(3,O)),m(2),x((t.groupedAnimals()[e.id_habitat]||j(4,O)).length>1?6:-1),m(),x((t.groupedAnimals()[e.id_habitat]||j(5,O)).length?-1:7)}}var xe=class l{constructor(i,e,t,a,n){this.animalManagement=i;this.habitatService=e;this.countResourceService=t;this.toastService=a;this.fileSecurityService=n}animals=f([]);habitats=f([]);selectedHabitat=f(null);selectedFile=f(null);groupedAnimals=f({});visibleAnimals=f({});newAnimalData=f({});animalToDelete=null;imageBaseUrl=`${R.apiUrl}/api`;filteredAnimals=X(()=>this.animals().filter(i=>i.habitat_id===this.selectedHabitat()));ngOnInit(){this.loadHabitats(),this.loadAnimals()}loadHabitats(){this.habitatService.getHabitats().subscribe({next:i=>this.habitats.set(i),error:i=>{console.error("Erreur de chargement des habitats :",i),this.toastService.showError("Erreur lors du chargement des habitats")}})}loadAnimals(){this.animalManagement.getAllAnimals().subscribe({next:i=>{this.animals.set(i.map(e=>C(h({},e),{showTime:!1,images:`${this.imageBaseUrl}/${e.images}`}))),this.groupAnimals()},error:i=>{console.error("Erreur de chargement des animaux :",i),this.toastService.showError("Erreur lors du chargement des animaux")}})}onFileChange(i){let e=i.target;e.files&&e.files.length>0&&(this.selectedFile.set(e.files[0]),this.toastService.showSuccess("Image s\xE9lectionn\xE9e avec succ\xE8s"))}createAnimal(){if(this.validateAnimalData()){let i=this.buildFormData();this.animalManagement.createAnimal(i).subscribe({next:()=>{this.resetForm(),this.loadAnimals(),this.countResourceService.incrementTotalAnimals(),this.toastService.showSuccess("Animal cr\xE9\xE9 avec succ\xE8s")},error:e=>{console.error("Erreur de cr\xE9ation de l'animal :",e),this.toastService.showError("Erreur lors de la cr\xE9ation de l'animal")}})}else this.toastService.showError("Veuillez remplir tous les champs requis")}updateAnimal(){if(this.validateAnimalData(!0)){let i=this.buildFormData(),e=this.newAnimalData().id_animal.toString();console.log("Donn\xE9es \xE0 envoyer:",{id:e,name:i.get("name"),species:i.get("species")}),this.animalManagement.updateAnimal(e,i).subscribe({next:t=>{t.name!==i.get("name")&&this.toastService.showWarning("Les donn\xE9es re\xE7ues diff\xE8rent des donn\xE9es envoy\xE9es");let a=C(h({},t),{images:t.images??""});this.animals.update(n=>n.map(d=>d.id_animal===a.id_animal?a:d)),this.groupAnimals(),this.resetForm(),this.toastService.showSuccess("Animal mis \xE0 jour avec succ\xE8s")},error:t=>{console.error("Erreur lors de la mise \xE0 jour de l'animal:",t),this.toastService.showError("Erreur lors de la mise \xE0 jour de l'animal")}})}else this.toastService.showError("Veuillez remplir tous les champs requis")}editAnimal(i){let e=this.animals().find(t=>t.id_animal===i);e&&(this.newAnimalData.set(h({},e)),this.toastService.showSuccess("Animal s\xE9lectionn\xE9 pour modification"))}deleteAnimal(i){let e=this.animals().find(a=>a.id_animal===i);if(!e)return;let t=`\xCAtes-vous s\xFBr de vouloir supprimer l'animal "${e.name}" ?`;confirm(t)?this.animalManagement.deleteAnimal(i.toString()).subscribe({next:()=>{this.animals.update(a=>a.filter(n=>n.id_animal!==i)),this.groupAnimals(),this.countResourceService.decrementTotalAnimals(),this.loadAnimals(),this.resetForm(),this.toastService.showSuccess("Animal supprim\xE9 avec succ\xE8s")},error:a=>{console.error("Erreur de suppression de l'animal :",a),this.toastService.showError("Erreur lors de la suppression de l'animal")}}):this.toastService.showSuccess("Suppression annul\xE9e")}resetForm(){this.newAnimalData.set({}),this.selectedFile.set(null)}cancel(){this.resetForm(),this.toastService.showSuccess("Formulaire r\xE9initialis\xE9")}toggleAnimal(i){if(!this.animals().find(a=>a.id_animal===i)){console.error("Animal non trouv\xE9:",i);return}let t=this.animals().map(a=>a.id_animal===i?C(h({},a),{showTime:!a.showTime}):a);this.animals.set(t),this.groupAnimals()}toggleVisibility(i){this.visibleAnimals.update(e=>C(h({},e),{[i]:!e[i]}))}isAnimalVisible(i){return this.visibleAnimals()[i.habitat_id]??!1}shouldShowFullDescription(i){let e=!!i.showTime;return console.log(`V\xE9rification description pour ${i.name}:`,e),e}validateAnimalData(i=!1){let e=[this.newAnimalData().name,this.newAnimalData().species,this.newAnimalData().habitat_id,this.newAnimalData().characteristics,this.newAnimalData().weightRange,this.newAnimalData().diet];return i&&e.push(this.newAnimalData().id_animal),e.every(t=>t!=null)}buildFormData(){let i=new FormData,e=this.newAnimalData();Object.entries(e).forEach(([a,n])=>{n!=null&&i.append(a,typeof n=="object"?JSON.stringify(n):String(n))});let t=this.selectedFile();return t&&i.append("images",t),i}groupAnimals(){let i=this.animals().reduce((e,t)=>(e[t.habitat_id]||(e[t.habitat_id]=[]),e[t.habitat_id].push(h({},t)),e),{});this.groupedAnimals.set(i)}onFileSelected(i){return L(this,null,function*(){let e=i.target.files?.[0];if(e)try{let t=yield this.fileSecurityService.validateFile(e);if(!t.isValid){this.toastService.showError(t.errors.join(`
`));return}this.selectedFile.set(e);let a=new FileReader;a.onload=()=>{this.newAnimalData.update(n=>C(h({},n),{images:a.result}))},a.readAsDataURL(e),this.toastService.showSuccess("Image s\xE9lectionn\xE9e avec succ\xE8s")}catch(t){console.error("Erreur lors du traitement du fichier:",t),this.toastService.showError("Erreur lors du traitement du fichier")}})}confirmDeleteAnimal(i){this.animalToDelete=i}cancelDelete(){this.animalToDelete=null}deleteAnimalConfirmed(){this.animalToDelete!==null&&(this.deleteAnimal(this.animalToDelete),this.animalToDelete=null)}static \u0275fac=function(e){return new(e||l)(S(H),S(pe),S(ge),S(Y),S(he))};static \u0275cmp=q({type:l,selectors:[["app-animal-management"]],standalone:!0,features:[z],decls:63,vars:16,consts:[[1,"w-full","bg-gradient-to-b","from-secondary","to-primary","shadow-lg","py-8"],[1,"container","mx-auto","px-4"],[1,"text-center","space-y-4","mb-12"],[1,"text-3xl","md:text-5xl","lg:text-6xl","font-serif","font-bold","text-quinary"],[1,"text-lg","md:text-xl","text-tertiary","font-serif","italic","max-w-4xl","mx-auto"],[1,"flex","flex-col","lg:flex-row","gap-8"],[1,"w-full","lg:w-1/2","bg-white","rounded-2xl","shadow-lg","p-6","space-y-6"],[1,"text-2xl","font-serif","font-semibold","text-tertiary","mb-6"],["enctype","multipart/form-data",1,"space-y-6",3,"ngSubmit"],["for","name",1,"block","text-lg","font-medium","text-tertiary","mb-2"],["type","text","id","name","name","name","required","","placeholder","Nom de l'animal",1,"w-full","p-3","border","border-secondary/30","rounded-lg","focus:ring-2","focus:ring-tertiary","focus:border-transparent",3,"ngModelChange","ngModel"],["for","species",1,"block","text-lg","font-medium","text-tertiary","mb-2"],["type","text","id","species","name","species","required","","placeholder","Esp\xE8ce de l'animal",1,"w-full","p-3","border","border-secondary/30","rounded-lg","focus:ring-2","focus:ring-tertiary","focus:border-transparent",3,"ngModelChange","ngModel"],[1,"form-group"],["for","animalImage",1,"block","text-sm","font-medium","text-gray-700","mb-2"],[1,"flex","items-center","justify-center","w-full"],[1,"flex","flex-col","items-center","justify-center","w-full","h-64","border-2","border-gray-300","border-dashed","rounded-lg","cursor-pointer","bg-gray-50","hover:bg-gray-100","transition-all","duration-300"],[1,"flex","flex-col","items-center","justify-center","pt-5","pb-6"],["alt","Aper\xE7u",1,"w-full","h-full","object-cover","rounded-lg",3,"src"],["id","animalImage","type","file","accept","image/*",1,"hidden",3,"change"],["for","animal-habitat",1,"block","text-lg","font-medium","text-tertiary","mb-2"],["id","animal-habitat","name","habitat_id","required","",1,"w-full","p-3","border","border-secondary/30","rounded-lg","focus:ring-2","focus:ring-tertiary","focus:border-transparent",3,"ngModelChange","ngModel"],["value",""],[3,"value"],["for","characteristics",1,"block","text-lg","font-medium","text-tertiary","mb-2"],["id","characteristics","name","characteristics","required","","rows","3","placeholder","Ex: sociable, actif, joueur",1,"w-full","p-3","border","border-secondary/30","rounded-lg","focus:ring-2","focus:ring-tertiary","focus:border-transparent",3,"ngModelChange","ngModel"],["for","weight-range",1,"block","text-lg","font-medium","text-tertiary","mb-2"],["type","text","id","weight-range","name","weightRange","required","","placeholder","Ex: 150 \xE0 300 kg",1,"w-full","p-3","border","border-secondary/30","rounded-lg","focus:ring-2","focus:ring-tertiary","focus:border-transparent",3,"ngModelChange","ngModel"],["for","diet",1,"block","text-lg","font-medium","text-tertiary","mb-2"],["id","diet","name","diet","required","",1,"w-full","p-3","border","border-secondary/30","rounded-lg","focus:ring-2","focus:ring-tertiary","focus:border-transparent",3,"ngModelChange","ngModel"],["value","Herbivore"],["value","Carnivore"],["value","Omnivore"],[1,"flex","gap-4","pt-4"],[1,"w-1/2",3,"text","type","color","rounded"],[1,"w-1/2",3,"click","keydown","text","type","color","rounded"],[1,"w-full","lg:w-1/2","space-y-8"],[1,"bg-white","rounded-2xl","shadow-lg","p-6"],["aria-hidden","true","xmlns","http://www.w3.org/2000/svg","fill","none","viewBox","0 0 20 16",1,"w-8","h-8","mb-4","text-gray-500"],["stroke","currentColor","stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"],[1,"mb-2","text-sm","text-gray-500"],[1,"font-semibold"],[1,"text-xs","text-gray-500"],[1,"text-2xl","font-serif","font-semibold","text-tertiary","mb-6","text-center"],[1,"space-y-4"],[1,"text-center","mt-4"],[1,"text-center","text-gray-500","italic"],[1,"bg-gray-50","rounded-xl","p-4","shadow-md","hover:shadow-lg","transition-all","duration-300","relative"],[1,"flex","flex-col","sm:flex-row","items-center","gap-4"],[1,"w-32","h-32","object-cover","rounded-lg","shadow-md",3,"src","alt"],[1,"flex-1","space-y-2"],[1,"text-lg","font-bold","text-tertiary"],[1,"text-gray-600"],[1,"text-sm","text-gray-600"],[1,"text-tertiary","hover:text-tertiary/80","ml-2","underline",3,"click"],[1,"flex","gap-2"],[3,"click","keydown","text","type","color","rounded","customClass"],[1,"mt-4","p-4","bg-red-100","rounded-lg"],[1,"flex","justify-end","gap-2","mt-2"],[1,"px-4","py-2","bg-red-500","text-white","rounded","hover:bg-red-600",3,"click"],[1,"px-4","py-2","bg-gray-300","text-gray-700","rounded","hover:bg-gray-400",3,"click"]],template:function(e,t){e&1&&(r(0,"section",0)(1,"div",1)(2,"div",2)(3,"h1",3),s(4," Gestion des Animaux "),o(),r(5,"p",4),s(6," G\xE9rez les animaux du zoo et leurs habitats "),o(),E(7,"app-toast"),o(),r(8,"div",5)(9,"div",6)(10,"h3",7),s(11),o(),r(12,"form",8),_("ngSubmit",function(){return t.newAnimalData().id_animal?t.updateAnimal():t.createAnimal()}),r(13,"div")(14,"label",9),s(15," Nom de l'animal "),o(),r(16,"input",10),y("ngModelChange",function(n){return A(t.newAnimalData().name,n)||(t.newAnimalData().name=n),n}),o()(),r(17,"div")(18,"label",11),s(19," Esp\xE8ce "),o(),r(20,"input",12),y("ngModelChange",function(n){return A(t.newAnimalData().species,n)||(t.newAnimalData().species=n),n}),o()(),r(21,"div",13)(22,"label",14),s(23," Image de l'animal "),o(),r(24,"div",15)(25,"label",16),b(26,Ae,9,0,"div",17)(27,ye,1,1,"img",18),r(28,"input",19),_("change",function(n){return t.onFileSelected(n)}),o()()()(),r(29,"div")(30,"label",20),s(31," Habitat "),o(),r(32,"select",21),y("ngModelChange",function(n){return A(t.newAnimalData().habitat_id,n)||(t.newAnimalData().habitat_id=n),n}),r(33,"option",22),s(34,"S\xE9lectionner un habitat"),o(),T(35,Ce,2,2,"option",23,fe),o()(),r(37,"div")(38,"label",24),s(39," Caract\xE9ristiques "),o(),r(40,"textarea",25),y("ngModelChange",function(n){return A(t.newAnimalData().characteristics,n)||(t.newAnimalData().characteristics=n),n}),o()(),r(41,"div")(42,"label",26),s(43," Fourchette de poids "),o(),r(44,"input",27),y("ngModelChange",function(n){return A(t.newAnimalData().weightRange,n)||(t.newAnimalData().weightRange=n),n}),o()(),r(45,"div")(46,"label",28),s(47," R\xE9gime alimentaire "),o(),r(48,"select",29),y("ngModelChange",function(n){return A(t.newAnimalData().diet,n)||(t.newAnimalData().diet=n),n}),r(49,"option",22),s(50,"S\xE9lectionner un r\xE9gime"),o(),r(51,"option",30),s(52,"Herbivore"),o(),r(53,"option",31),s(54,"Carnivore"),o(),r(55,"option",32),s(56,"Omnivore"),o()()(),r(57,"div",33),E(58,"app-button",34),r(59,"app-button",35),_("click",function(){return t.cancel()})("keydown",function(n){return n.key==="Enter"&&t.cancel()}),o()()()(),r(60,"div",36),T(61,Re,8,6,"div",37,fe),o()()()()),e&2&&(m(11),v(" ",t.newAnimalData().id_animal?"Modifier l'animal":"Ajouter un animal"," "),m(5),w("ngModel",t.newAnimalData().name),m(4),w("ngModel",t.newAnimalData().species),m(6),x(t.newAnimalData().images?27:26),m(6),w("ngModel",t.newAnimalData().habitat_id),m(3),k(t.habitats()),m(5),w("ngModel",t.newAnimalData().characteristics),m(4),w("ngModel",t.newAnimalData().weightRange),m(4),w("ngModel",t.newAnimalData().diet),m(10),g("text",t.newAnimalData().id_animal?"Modifier":"Cr\xE9er")("type","submit")("color","tertiary")("rounded",!0),m(),g("text","Annuler")("type","button")("color","secondary")("rounded",!0),m(2),k(t.habitats()))},dependencies:[K,ce,ae,oe,le,Z,re,ee,te,se,me,ne,ie,ue,de],encapsulation:2})};export{xe as AnimalManagementComponent};
