import{a as rt}from"./chunk-ZKKSB4BP.js";import{a as at}from"./chunk-DRNBQNPL.js";import{a as tt}from"./chunk-IMR7M5YK.js";import{a as it}from"./chunk-MR4UGKWL.js";import{a as A}from"./chunk-VV7GXU3B.js";import{e as q}from"./chunk-OTF63C3I.js";import{a as et}from"./chunk-M6XTAS6A.js";import{c as L,e as G,f as P,h as J,j as K,k as Q,s as X,u as Y,v as Z}from"./chunk-IVPOVWWL.js";import{H as v,Hb as m,Ib as z,Jb as D,Ma as V,Mb as M,Nb as F,Nc as B,Ob as I,Qb as W,Qc as H,Sa as l,Ta as b,X as w,_ as j,_a as E,a as d,b as g,d as k,da as y,db as O,hb as _,ia as T,mb as R,pb as U,q as x,qb as $,rb as n,sa as p,sb as o,ta as u,tb as N,xb as C,yb as h,zb as f}from"./chunk-RMHEMJYH.js";var S=class s{constructor(i,e){this.http=i;this.habitatService=e}apiUrl=`${H.apiUrl}/api/admin/habitats`;getAllHabitats(){return this.http.get(this.apiUrl).pipe(w(i=>console.log("Habitats re\xE7us:",i)),v(i=>this.handleError("chargement des habitats",i)))}createHabitat(i){return this.http.post(this.apiUrl,i).pipe(w(e=>{console.log("R\xE9ponse du serveur (cr\xE9ation):",e),this.habitatService.clearCache()}),v(e=>(console.error("Erreur d\xE9taill\xE9e (cr\xE9ation):",e),this.handleError("cr\xE9ation de l'habitat",e))))}updateHabitat(i,e,t){if(!i)return x(()=>new Error("ID invalide"));let r=new FormData;return Object.entries(e).forEach(([a,c])=>{c!=null&&a!=="images"&&r.append(a,typeof c=="object"?JSON.stringify(c):String(c))}),t&&r.append("images",t),this.http.put(`${this.apiUrl}/${i}`,r).pipe(w(a=>{console.log("R\xE9ponse du serveur (mise \xE0 jour):",a),this.habitatService.clearCache()}),v(a=>(console.error("Erreur d\xE9taill\xE9e (mise \xE0 jour):",a),this.handleError("mise \xE0 jour de l'habitat",a))))}deleteHabitat(i){return this.http.delete(`${this.apiUrl}/${i}`).pipe(w(()=>{console.log("Habitat supprim\xE9 avec succ\xE8s:",i),this.habitatService.clearCache()}),v(e=>(console.error("Erreur lors de la suppression:",e),this.handleError("suppression de l'habitat",e))))}handleError(i,e){return console.error(`Erreur lors de ${i}:`,e),x(()=>new Error(`Erreur lors de ${i}`))}static \u0275fac=function(e){return new(e||s)(y(B),y(tt))};static \u0275prov=j({token:s,factory:s.\u0275fac,providedIn:"root"})};var lt=(s,i)=>i.id_habitat;function ct(s,i){if(s&1){let e=C();n(0,"div",6)(1,"div",19),N(2,"img",20),n(3,"div",21)(4,"h3",22),m(5),o()()(),n(6,"div",23)(7,"p",24),m(8),o(),n(9,"div",25)(10,"app-button",26),h("click",function(){let r=p(e).$implicit,a=f();return u(a.editHabitat(r.id_habitat))})("keydown",function(){let r=p(e).$implicit,a=f();return u(a.editHabitat(r.id_habitat))}),o(),n(11,"app-button",26),h("click",function(){let r=p(e).$implicit,a=f();return u(a.deleteHabitat(r.id_habitat))})("keydown",function(){let r=p(e).$implicit,a=f();return u(a.deleteHabitat(r.id_habitat))}),o()()()()}if(s&2){let e=i.$implicit;l(2),_("src",e.images,V)("alt",e.name),l(3),z(e.name),l(3),D(" ",e.description," "),l(2),_("text","Modifier")("color","tertiary")("rounded",!0)("customClass","px-6 min-w-[120px] text-lg font-medium"),l(),_("text","Supprimer")("color","danger")("rounded",!0)("customClass","px-6 min-w-[120px] text-lg font-medium")}}function mt(s,i){if(s&1){let e=C();n(0,"app-button",27),h("click",function(){p(e);let r=f();return u(r.cancelEdit())})("keydown",function(){p(e);let r=f();return u(r.cancelEdit())}),o()}s&2&&_("text","Annuler")("color","secondary")("rounded",!0)("customClass","px-6 min-w-[120px] text-lg font-medium")}var nt=class s{constructor(i,e,t,r,a,c){this.router=i;this.habitatManagement=e;this.countResourceService=t;this.toastService=r;this.fileSecurityService=a;this.imageOptimizer=c}habitats=E([]);selectedFile=E(null);newHabitatData={};imageBaseUrl=`${H.apiUrl}/api`;ngOnInit(){this.loadHabitats()}loadHabitats(){this.habitatManagement.getAllHabitats().subscribe({next:i=>{let e=t=>t?t.startsWith("http")?t:`${this.imageBaseUrl}/${t.replace(/^\/+/,"")}`:null;this.habitats.set(i.map(t=>g(d({},t),{showDescription:!1,showDeleteConfirmation:!1,images:e(t.images)})))},error:i=>{console.error("Erreur lors de la r\xE9cup\xE9ration des habitats:",i),this.toastService.showError("Erreur lors du chargement des habitats")}})}onFileSelected(i){return k(this,null,function*(){let e=i.target.files?.[0];if(e)try{let t=yield this.fileSecurityService.scan(e);if(!t.isSafe){this.toastService.showError(t.threats.join(`
`));return}this.selectedFile.set(e);let r=new FileReader;r.onload=()=>{this.newHabitatData.images=r.result},r.readAsDataURL(e),this.toastService.showSuccess("Image s\xE9lectionn\xE9e avec succ\xE8s")}catch(t){console.error("Erreur lors du traitement du fichier:",t),this.toastService.showError("Erreur lors du traitement du fichier")}})}createHabitat(){if(this.validateHabitatData()){let i=this.buildFormData();this.habitatManagement.createHabitat(i).subscribe({next:()=>{this.resetForm(),this.loadHabitats(),this.countResourceService.incrementTotalHabitats(),this.toastService.showSuccess("Habitat cr\xE9\xE9 avec succ\xE8s")},error:e=>{console.error("Erreur lors de la cr\xE9ation de l'habitat :",e),this.toastService.showError("Erreur lors de la cr\xE9ation de l'habitat")}})}else this.toastService.showError("Veuillez remplir tous les champs requis")}updateHabitat(){if(this.validateHabitatData(!0)){let i=this.newHabitatData.id_habitat.toString(),e={name:this.newHabitatData.name,description:this.newHabitatData.description,id_habitat:this.newHabitatData.id_habitat};this.habitatManagement.updateHabitat(i,e,this.selectedFile()).subscribe({next:t=>{let r=this.formatImageUrl(t.images);this.habitats.update(a=>a.map(c=>c.id_habitat===t.id_habitat?g(d({},t),{showDescription:c.showDescription,images:r}):c)),this.resetForm(),this.toastService.showSuccess("Habitat mis \xE0 jour avec succ\xE8s")},error:t=>{console.error("Erreur lors de la mise \xE0 jour de l'habitat:",t),this.toastService.showError("Erreur lors de la mise \xE0 jour de l'habitat")}})}else this.toastService.showError("Veuillez remplir tous les champs requis")}formatImageUrl(i){if(!i)return"";if(i.startsWith("http"))return i;let e=i.replace(/uploads\/habitats\/uploads\/habitats\//,"uploads/habitats/");return`${this.imageBaseUrl}/${e}`}editHabitat(i){let e=this.habitats().find(t=>t.id_habitat===i);e&&(this.newHabitatData=d({},e),this.toastService.showSuccess("Habitat s\xE9lectionn\xE9 pour modification"))}confirmDeleteHabitat(i){this.habitats.update(e=>e.map(t=>t.id_habitat===i?g(d({},t),{showDeleteConfirmation:!0}):t))}cancelDeleteHabitat(i){this.habitats.update(e=>e.map(t=>t.id_habitat===i?g(d({},t),{showDeleteConfirmation:!1}):t))}deleteHabitat(i){if(!i){this.toastService.showError("ID d'habitat invalide");return}this.habitatManagement.deleteHabitat(i.toString()).subscribe({next:()=>{this.habitats.update(e=>e.filter(t=>t.id_habitat!==i)),this.countResourceService.decrementTotalHabitats(),this.loadHabitats(),this.resetForm(),this.toastService.showSuccess("Habitat supprim\xE9 avec succ\xE8s")},error:e=>{console.error("Erreur lors de la suppression de l'habitat:",e),this.toastService.showError("Erreur lors de la suppression de l'habitat")}})}resetForm(){this.newHabitatData={},this.selectedFile.set(null)}cancelEdit(){this.resetForm(),this.toastService.showSuccess("Modification annul\xE9e")}toggleDescription(i){this.habitats.update(e=>e.map(t=>t.id_habitat===i?g(d({},t),{showDescription:!t.showDescription}):t))}goBack(){this.router.navigate(["/admin"])}validateHabitatData(i=!1){let{name:e,description:t}=this.newHabitatData,r=i||this.newHabitatData.images||this.selectedFile();return!!(e&&t&&r)}buildFormData(){let i=new FormData,e=this.newHabitatData;Object.entries(e).forEach(([r,a])=>{a!=null&&i.append(r,a.toString())});let t=this.selectedFile();if(t){let r=this.imageOptimizer.sanitizeFileName(t.name);i.append("images",t,r)}return i}static \u0275fac=function(e){return new(e||s)(b(q),b(S),b(it),b(A),b(at),b(rt))};static \u0275cmp=T({type:s,selectors:[["app-habitat-management"]],standalone:!0,features:[W],decls:29,vars:8,consts:[[1,"w-full","bg-gradient-to-b","from-secondary","to-primary","shadow-lg","py-8"],[1,"container","mx-auto","px-4"],[1,"text-center","space-y-4","mb-12"],[1,"text-3xl","md:text-5xl","lg:text-6xl","font-serif","font-bold","text-quinary"],[1,"text-lg","md:text-xl","text-tertiary","font-serif","italic","max-w-4xl","mx-auto"],[1,"grid","grid-cols-1","md:grid-cols-2","lg:grid-cols-3","gap-6","mb-12"],[1,"bg-white/80","backdrop-blur-sm","rounded-xl","shadow-lg","overflow-hidden"],[1,"bg-white/80","backdrop-blur-sm","rounded-xl","shadow-lg","p-6"],[1,"text-2xl","font-serif","font-semibold","text-tertiary","mb-6"],["enctype","multipart/form-data",1,"space-y-6",3,"ngSubmit"],["for","name",1,"block","text-lg","font-medium","text-tertiary","mb-2"],["type","text","id","name","name","name","required","","placeholder","Nom de l'habitat",1,"w-full","p-3","border","border-secondary/30","rounded-lg","focus:ring-2","focus:ring-tertiary","focus:border-transparent",3,"ngModelChange","ngModel"],["for","description",1,"block","text-lg","font-medium","text-tertiary","mb-2"],["id","description","name","description","required","","rows","4","placeholder","Description de l'habitat",1,"w-full","p-3","border","border-secondary/30","rounded-lg","focus:ring-2","focus:ring-tertiary","focus:border-transparent",3,"ngModelChange","ngModel"],["for","image",1,"block","text-lg","font-medium","text-tertiary","mb-2"],["type","file","id","image","accept","image/*",1,"w-full","p-3","border","border-secondary/30","rounded-lg","focus:ring-2","focus:ring-tertiary","focus:border-transparent",3,"change"],[1,"flex","justify-end","space-x-4"],["type","button",3,"text","color","rounded","customClass"],["type","submit",3,"keydown","text","color","rounded","customClass"],[1,"relative","h-48"],[1,"w-full","h-full","object-cover",3,"src","alt"],[1,"absolute","bottom-0","left-0","right-0","bg-black/50","p-4"],[1,"text-white","font-serif","text-xl"],[1,"p-4"],[1,"text-gray-600","mb-4","line-clamp-3"],[1,"flex","justify-end","space-x-2"],[3,"click","keydown","text","color","rounded","customClass"],["type","button",3,"click","keydown","text","color","rounded","customClass"]],template:function(e,t){e&1&&(n(0,"section",0)(1,"div",1)(2,"div",2)(3,"h1",3),m(4," Gestion des Habitats "),o(),n(5,"p",4),m(6," G\xE9rez les habitats du zoo "),o()(),n(7,"div",5),U(8,ct,12,12,"div",6,lt),o(),n(10,"div",7)(11,"h3",8),m(12),o(),n(13,"form",9),h("ngSubmit",function(){return t.newHabitatData.id_habitat?t.updateHabitat():t.createHabitat()}),n(14,"div")(15,"label",10),m(16," Nom de l'habitat "),o(),n(17,"input",11),I("ngModelChange",function(a){return F(t.newHabitatData.name,a)||(t.newHabitatData.name=a),a}),o()(),n(18,"div")(19,"label",12),m(20," Description "),o(),n(21,"textarea",13),I("ngModelChange",function(a){return F(t.newHabitatData.description,a)||(t.newHabitatData.description=a),a}),o()(),n(22,"div")(23,"label",14),m(24," Image "),o(),n(25,"input",15),h("change",function(a){return t.onFileSelected(a)}),o()(),n(26,"div",16),O(27,mt,1,4,"app-button",17),n(28,"app-button",18),h("keydown",function(a){return a.key==="Enter"&&(t.newHabitatData.id_habitat?t.updateHabitat():t.createHabitat())}),o()()()()()()),e&2&&(l(8),$(t.habitats()),l(4),D(" ",t.newHabitatData.id_habitat?"Modifier l'habitat":"Ajouter un habitat"," "),l(5),M("ngModel",t.newHabitatData.name),l(4),M("ngModel",t.newHabitatData.description),l(6),R(t.newHabitatData.id_habitat?27:-1),l(),_("text",t.newHabitatData.id_habitat?"Mettre \xE0 jour":"Cr\xE9er")("color","tertiary")("rounded",!0)("customClass","px-6 min-w-[120px] text-lg font-medium"))},dependencies:[Z,Q,L,G,P,X,Y,K,J,et],encapsulation:2})};export{nt as HabitatManagementComponent};
