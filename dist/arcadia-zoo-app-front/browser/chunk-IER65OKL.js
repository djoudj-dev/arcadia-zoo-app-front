import{a as f}from"./chunk-2CBPXYGN.js";import{a as k}from"./chunk-TTATSR4U.js";import{e as v}from"./chunk-PRIUQE34.js";import{D as h,G as i,Tc as d,V as l,Wc as g,Y as p,ba as o,lc as n,q as s,qa as c}from"./chunk-JLM7LPRF.js";var m=class a{apiUrl=`${g.apiUrl}`;http=o(d);router=o(v);toastService=o(k);tokenService=o(f);authState=c({user:null,isAuthenticated:!1,role:null});user=n(()=>this.authState().user);isAuthenticated=n(()=>this.authState().isAuthenticated);userRole=n(()=>this.authState().role);constructor(){this.initializeCurrentUser(),this.isAuthenticated()&&h(6e4).subscribe(()=>this.checkTokenExpiration())}initializeCurrentUser(){let e=localStorage.getItem("user"),t=this.tokenService.getToken();if(e&&t)try{let r=JSON.parse(e);this.authState.set({user:r,isAuthenticated:!0,role:r.role?.name??null})}catch{this.handleInvalidUserData()}}login(e,t){return this.http.post(`${this.apiUrl}/api/auth/login`,{email:e,password:t}).pipe(l(r=>{this.handleSuccessfulLogin(r.user)}),i(r=>this.handleLoginError(r)))}refreshToken(){let e=this.tokenService.getRefreshToken();return e?this.http.post(`${this.apiUrl}/api/auth/token/refresh`,{refreshToken:e}).pipe(l(t=>{this.tokenService.setTokens(t.accessToken,t.refreshToken)}),i(t=>(console.error("Erreur de rafra\xEEchissement du token:",t),this.logout(),s(()=>t)))):(this.logout(),s(()=>new Error("Refresh token non trouv\xE9")))}logout(){this.tokenService.removeTokens(),localStorage.removeItem("user"),this.authState.set({user:null,isAuthenticated:!1,role:null}),this.router.navigate(["/"]),this.toastService.showAuthLogout("D\xE9connexion r\xE9ussie !")}checkTokenExpiration(){let e=this.tokenService.getToken();e&&this.tokenService.isTokenExpiringSoon(e)&&this.refreshToken().subscribe()}handleSuccessfulLogin(e){let t=e.token??"",r=e.refreshToken??"";this.tokenService.setTokens(t,r),localStorage.setItem("user",JSON.stringify(e)),this.authState.set({user:e,isAuthenticated:!0,role:e.role?.name??null}),this.router.navigate(["/"]),this.toastService.showAuthLogin("Connexion r\xE9ussie !")}handleLoginError(e){let t=e.error?.message||"Erreur de connexion. V\xE9rifiez vos identifiants.";return this.toastService.showError(t),s(()=>e)}handleInvalidUserData(){this.logout()}initiatePasswordReset(e){return this.http.post(`${this.apiUrl}/api/password-reset/initiate`,{email:e}).pipe(i(t=>(console.error("Erreur d'initiation de r\xE9initialisation:",t),s(()=>t))))}verifyResetCode(e,t){return this.http.post(`${this.apiUrl}/api/password-reset/verify`,{email:e,code:t}).pipe(i(r=>(console.error("Erreur de v\xE9rification du code:",r),s(()=>r))))}resetPassword(e,t,r){return this.http.post(`${this.apiUrl}/api/password-reset/reset`,{email:e,code:t,newPassword:r}).pipe(i(u=>(console.error("Erreur de r\xE9initialisation du mot de passe:",u),s(()=>u))))}static \u0275fac=function(t){return new(t||a)};static \u0275prov=p({token:a,factory:a.\u0275fac,providedIn:"root"})};export{m as a};
